@page "/"
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>IES 编辑器</PageTitle>

<MudLayout>
    <MudAppBar Color="Color.Primary" Fixed="true">
        <MudText Typo="Typo.h6">ShaoWentao IES Viewer</MudText>
    </MudAppBar>
    <MudMainContent Class="pt-16 px-4">
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudPaper Class="p-4" Elevation="3">
                        <MudText Typo="Typo.h5" Class="mb-4">上传 IES</MudText>
                        <MudFileUpload T="IBrowserFile" Accept=".ies" OnFilesChanged="UploadFile">
                            <ButtonTemplate>
                                <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload" for="@context.Id">选择文件</MudButton>
                            </ButtonTemplate>
                        </MudFileUpload>
                        @if(loaded) { <MudAlert Severity="Severity.Success" Class="mt-2">解析成功！</MudAlert> }
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudPaper Class="p-4 d-flex justify-center" Elevation="3">
                        <canvas id="iesCanvas" width="500" height="500"></canvas>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    bool loaded = false;
    private async Task UploadFile(InputFileChangeEventArgs e) {
        try {
            using var reader = new StreamReader(e.File.OpenReadStream(2000000));
            await reader.ReadToEndAsync();
            double[] mockData = {0, 10, 50, 100, 50, 10, 0}; // 演示用
            await JS.InvokeVoidAsync("drawPolarCurve", mockData);
            loaded = true;
        } catch { Snackbar.Add("错误", Severity.Error); }
    }
}
