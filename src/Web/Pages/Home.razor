@page "/"
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>专业 IES 编辑器</PageTitle>

<MudLayout>
    <MudAppBar Color="Color.Dark" Fixed="true" Elevation="2">
        <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-3" />
        <MudText Typo="Typo.h6">Viso 风格编辑器 (复刻版)</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" />
    </MudAppBar>

    <MudMainContent Class="pt-16 px-4" Style="background-color:#f5f5f5; min-height:100vh;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudPaper Class="p-4 mb-4" Elevation="3">
                        <MudText Typo="Typo.h6" Class="mb-3">文件导入</MudText>
                        <MudFileUpload T="IBrowserFile" Accept=".ies" OnFilesChanged="UploadFile">
                            <ButtonTemplate>
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.FolderOpen"
                                           for="@context.Id">
                                    打开 IES 文件
                                </MudButton>
                            </ButtonTemplate>
                        </MudFileUpload>
                    </MudPaper>

                    @if (iesData != null)
                    {
                        <MudPaper Class="p-0" Elevation="3">
                            <MudToolBar>
                                <MudText Typo="Typo.h6">灯具参数</MudText>
                            </MudToolBar>
                            <MudList Clickable="true" Dense="true">
                                <MudListItem Icon="@Icons.Material.Filled.Info">
                                    <b>厂家:</b> @iesData.Manufac
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.Light">
                                    <b>型号:</b> @iesData.Lumcat
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.FlashOn">
                                    <b>功率:</b> @iesData.InputWatts W
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.BrightnessHigh">
                                    <b>最大光强:</b> @iesData.MaxCandela.ToString("F1") cd
                                </MudListItem>
                                <MudListItem Icon="@Icons.Material.Filled.Numbers">
                                    <b>角度数:</b> V:@iesData.VerticalAngles.Count x H:@iesData.HorizontalAngles.Count
                                </MudListItem>
                            </MudList>
                        </MudPaper>
                    }
                </MudItem>

                <MudItem xs="12" md="8">
                    <MudPaper Class="p-4 d-flex flex-column align-center justify-center" Elevation="3" Style="height: 600px;">
                        @if (iesData == null)
                        {
                            <MudText Color="Color.Default" Typo="Typo.h5">请上传 IES 文件以查看配光曲线</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.InsertChartOutlined" Size="Size.Large" Color="Color.Default" Class="mt-4" Style="font-size: 5rem;" />
                        }
                        else
                        {
                            <MudText Typo="Typo.h6" Class="mb-2">配光曲线 (Polar Curve - C0/180 & C90/270)</MudText>
                            <canvas id="iesCanvas" width="500" height="500"></canvas>
                            <MudText Typo="Typo.caption" Class="mt-2 text-muted">红色: C0-180 | 蓝色: C90-270</MudText>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private IesData? iesData;

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        try
        {
            using var reader = new StreamReader(e.File.OpenReadStream(2097152)); // 2MB limit
            var text = await reader.ReadToEndAsync();

            // 1. 调用真正的解析算法
            iesData = IesParser.Parse(text);
            
            Snackbar.Add($"解析成功！包含 {iesData.VerticalAngles.Count * iesData.HorizontalAngles.Count} 个数据点", Severity.Success);

            // 2. 准备绘图数据
            // 我们提取 C0 (0度) 和 C90 (90度) 两条曲线
            if (iesData.CandelaValues.GetLength(0) > 0)
            {
                var vCount = iesData.VerticalAngles.Count;
                var c0 = new double[vCount];
                var c90 = new double[vCount];

                // 寻找 C0 平面
                int idxC0 = 0; // 默认第一个
                // 寻找 C90 平面 (简单查找)
                int idxC90 = 0;
                for(int i=0; i<iesData.HorizontalAngles.Count; i++) {
                    if (Math.Abs(iesData.HorizontalAngles[i] - 90) < 1) idxC90 = i;
                }

                for (int i = 0; i < vCount; i++)
                {
                    c0[i] = iesData.CandelaValues[idxC0, i];
                    c90[i] = iesData.CandelaValues[idxC90, i];
                }

                // 3. 调用 JS 画真图 (传入 C0 和 C90 两组数据)
                await JS.InvokeVoidAsync("drawPolarCurve", c0, c90);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"解析错误: {ex.Message}", Severity.Error);
        }
    }
}
