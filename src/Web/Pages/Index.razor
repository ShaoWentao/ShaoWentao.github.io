@page "/"
@using Photometric.Core.Readers.IES
@using Photometric.Core.Models.IES
@using System.IO
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>配光文件编辑器</PageTitle>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudPaper Elevation="3" Class="p-4">
            <MudText Typo="Typo.h5" Class="mb-4">文件操作</MudText>
            
            <MudFileUpload T="IBrowserFile" Accept=".ies" OnFilesChanged="UploadFile">
                <ButtonTemplate>
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               for="@context.Id">
                        上传 IES 文件
                    </MudButton>
                </ButtonTemplate>
            </MudFileUpload>

            @if (parsedResult != null)
            {
                <MudDivider Class="my-4" />
                <MudList T="string" Dense="true">
                    <MudText Typo="Typo.h6" Color="Color.Primary">解析数据</MudText>
                    <MudListItem Icon="@Icons.Material.Filled.Lightbulb">
                        <MudText><b>灯具数量:</b> @parsedResult.IesHeader.Photometry.LampCount</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.BrightnessHigh">
                        <MudText><b>单灯流明:</b> @parsedResult.IesHeader.Photometry.LumensPerLamp lm</MudText>
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Info">
                        <MudText><b>版本:</b> @parsedResult.IesHeader.IesVersion</MudText>
                    </MudListItem>
                     <MudListItem Icon="@Icons.Material.Filled.FlashOn">
                        <MudText><b>功率:</b> @parsedResult.IesHeader.Photometry.InputWatts W</MudText>
                    </MudListItem>
                </MudList>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudPaper Elevation="3" Class="p-4 d-flex flex-column align-center justify-center" Style="min-height: 500px;">
            <MudText Typo="Typo.h6" Class="mb-2">配光曲线 (Polar Curve)</MudText>
            
            <div style="background-color: transparent; border: 1px solid #eee;">
                <canvas id="iesCanvas" width="600" height="600"></canvas>
            </div>

            @if (parsedResult != null)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mt-4" OnClick="DownloadTransparentImage">
                    下载透明 PNG
                </MudButton>
            }
            else
            {
                <MudText Color="Color.Default">请先上传 IES 文件以生成预览</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    // 修正 1: 类型改为 IesParseResult
    private IesParseResult? parsedResult;

    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            // 修正 2: IesReader 是静态类，直接调用 Parse 方法
            parsedResult = IesReader.Parse(content);

            Snackbar.Add($"成功解析: {file.Name}", Severity.Success);

            // 修正 3: 提取 Candela 数据传给 JS 绘图
            // 这里我们取 C0 平面 (第一个水平角) 的数据作为演示
            // 真实情况可能需要根据用户选择的角度来切片
            if (parsedResult.Candela.Values.GetLength(0) > 0)
            {
                 var verticalCount = parsedResult.Candela.Values.GetLength(1);
                 var curveData = new double[verticalCount];
                 for(int i=0; i<verticalCount; i++) 
                 {
                     // 取第 0 个水平面的所有垂直角数据
                     curveData[i] = parsedResult.Candela.Values[0, i];
                 }
                 await JS.InvokeVoidAsync("drawPolarCurve", curveData); 
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"解析失败: {ex.Message}", Severity.Error);
            Console.WriteLine(ex);
        }
    }

    private async Task DownloadTransparentImage()
    {
        await JS.InvokeVoidAsync("downloadCanvasImage", "photometric-curve.png");
    }
}
