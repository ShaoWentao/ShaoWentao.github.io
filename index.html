<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES & LDT ä¸“ä¸šé…å…‰ç¼–è¾‘å™¨</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .drag-area { border: 2px dashed #cbd5e1; transition: all 0.3s; }
        .drag-area:hover, .drag-area.active { border-color: #3b82f6; background-color: #eff6ff; }
        /* Plotly å›¾è¡¨å®¹å™¨é«˜åº¦ */
        .plot-container { height: 450px; }
        .tab-btn { @apply px-4 py-2 font-semibold text-sm rounded-t-lg; }
        .tab-btn.active { @apply bg-white text-blue-600 border-t-2 border-blue-600; }
        .tab-btn.inactive { @apply bg-gray-100 text-gray-500 hover:bg-gray-200; }
    </style>
</head>
<body>

<div id="app" class="max-w-6xl mx-auto p-4">
    
    <div class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-gray-800">ğŸ’¡ IES & LDT é…å…‰åˆ†æä¸“ä¸šç‰ˆ</h1>
        <p class="text-gray-500 mt-2 text-sm">å¯è§†åŒ–ç¼–è¾‘ / æåæ ‡ & ç›´è§’åæ ‡å›¾ / å¯¹ç§°æ€§ä¿®æ”¹</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
        <div 
            class="drag-area rounded-lg p-8 text-center cursor-pointer"
            @click="$refs.fileInput.click()"
            @dragover.prevent
            @drop.prevent="handleDrop"
        >
            <input type="file" ref="fileInput" class="hidden" accept=".ies,.ldt" @change="handleFileSelect">
            <div v-if="!fileName">
                <p class="text-4xl mb-2">ğŸ“‚</p>
                <p class="text-gray-600 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  IES / LDT æ–‡ä»¶</p>
            </div>
            <div v-else class="flex items-center justify-center gap-4">
                <div class="text-4xl">ğŸ“„</div>
                <div class="text-left">
                    <p class="text-green-600 font-bold text-lg truncate max-w-md">{{ fileName }}</p>
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded uppercase">
                        {{ fileType }} æ ¼å¼
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div v-if="parsedData" class="bg-white rounded-xl shadow-sm overflow-hidden animate-fade-in">
        
        <div class="flex border-b bg-gray-50 px-4 pt-4 gap-2">
             <button @click="currentTab = 'editor'" :class="['tab-btn', currentTab === 'editor' ? 'active' : 'inactive']">ğŸ“ å‚æ•°ç¼–è¾‘</button>
             <button @click="currentTab = 'polar'" :class="['tab-btn', currentTab === 'polar' ? 'active' : 'inactive']">ğŸ•¸ï¸ æåæ ‡å›¾ (Polar)</button>
             <button @click="currentTab = 'cartesian'" :class="['tab-btn', currentTab === 'cartesian' ? 'active' : 'inactive']">ğŸ“ˆ ç›´è§’åæ ‡å›¾ (Cartesian)</button>
        </div>

        <div class="p-6">
            <div v-show="currentTab === 'editor'">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-xl font-bold text-gray-700">åŸºæœ¬ä¿¡æ¯ä¸å‚æ•°</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å‚å®¶ (Manufacturer)</label>
                        <input v-model="parsedData.manufacturer" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç¯å…·åç§° (Luminaire Name)</label>
                        <input v-model="parsedData.luminaireName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç³»ç»ŸåŠŸç‡ (Watts)</label>
                        <input type="number" v-model.number="parsedData.watts" step="0.1" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    
                    <div v-if="fileType === 'ies'">
                        <label class="block text-sm font-medium text-gray-700 mb-1">å…‰é€šé‡å€å¢å› å­ (Multiplier)</label>
                        <input type="number" v-model.number="parsedData.multiplier" step="0.001" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50">
                    </div>
                    <div v-if="fileType === 'ldt'">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ€»å…‰é€šé‡ (Total Flux)</label>
                        <input type="number" v-model.number="parsedData.totalFlux" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“å‹å· (Catalog/Type)</label>
                        <input v-model="parsedData.catalogNumber" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div v-if="fileType === 'ldt'" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <h3 class="text-sm font-bold text-blue-800 mb-2">ğŸ”„ å¯¹ç§°æ€§è®¾ç½® (LDT)</h3>
                    <select v-model.number="parsedData.symmetryIndicator" class="w-full p-2 border rounded outline-none">
                        <option value="0">0 - éå¯¹ç§° (Asymmetric)</option>
                        <option value="1">1 - å…³äº C0-C180 è½´å¯¹ç§° (Bilateral)</option>
                        <option value="2">2 - å…³äº C0-180 å’Œ C90-270 å››åˆ†å¯¹ç§° (Quadrilateral)</option>
                        <option value="3">3 - å…³äºæ‰€æœ‰ C å¹³é¢æ—‹è½¬å¯¹ç§° (Rotational)</option>
                    </select>
                    <p class="text-xs text-blue-500 mt-2">ä¿®æ”¹æ­¤é¡¹å°†æ”¹å˜è½¯ä»¶è§£ææ•°æ®çš„æ–¹å¼ã€‚</p>
                </div>
                
                <div v-if="fileType === 'ies' && iesSymmetryInfo" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">â„¹ï¸ IES å¯¹ç§°æ€§ä¿¡æ¯ (åªè¯»)</h3>
                    <p class="text-sm text-gray-600">{{ iesSymmetryInfo }}</p>
                    <p class="text-xs text-gray-400 mt-1">IES å¯¹ç§°æ€§ç”±æ°´å¹³è§’åº¦èŒƒå›´å†³å®šï¼Œä¿®æ”¹éœ€è¦é‡æ„æ•°æ®çŸ©é˜µï¼Œæš‚ä¸æ”¯æŒåœ¨çº¿ä¿®æ”¹ã€‚</p>
                </div>


                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-600 mb-2">æ‰©å±•ä¿¡æ¯ (CCT / CRI)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">è‰²æ¸© (CCT)</label>
                            <input v-model="parsedData.cct" placeholder="ä¾‹å¦‚: 3000K" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500">æ˜¾è‰²æŒ‡æ•° (CRI)</label>
                            <input v-model="parsedData.cri" placeholder="ä¾‹å¦‚: Ra90" class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>
                     <p v-if="fileType === 'ldt'" class="text-xs text-orange-500 mt-2">âš ï¸ LDT å°†è¿½åŠ åˆ°ç¯å…·åç§°åä¿å­˜ã€‚</p>
                </div>

                 <button 
                    @click="downloadFile" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex justify-center items-center gap-2"
                >
                    <span>â¬‡ï¸ ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶</span>
                </button>

            </div>

            <div v-show="currentTab === 'polar'">
                <div id="polarPlot" class="plot-container"></div>
                <div class="text-center text-sm text-gray-500 mt-2">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span> C0/180 å¹³é¢
                    <span class="inline-block w-3 h-3 bg-blue-500 rounded-full ml-4 mr-1"></span> C90/270 å¹³é¢ (å¦‚æœå­˜åœ¨)
                </div>
            </div>

            <div v-show="currentTab === 'cartesian'">
                <div id="cartesianPlot" class="plot-container"></div>
                 <div class="text-center text-sm text-gray-500 mt-2">
                    æ˜¾ç¤ºå…‰å¼ºéšå‚ç›´è§’åº¦ (Î³) çš„å˜åŒ–
                </div>
            </div>

        </div>
    </div>

</div>

<script>
    const { createApp, nextTick } = Vue

    createApp({
        data() {
            return {
                currentTab: 'editor',
                fileName: '',
                fileType: '',
                rawContent: '',
                rawLines: [],
                // è§£æåçš„æ ¸å¿ƒæ•°æ®æ¨¡å‹
                parsedData: null, 
                // { manufacturer, luminaireName, catalogNumber, watts, multiplier(ies), totalFlux(ldt), cct, cri, symmetryIndicator(ldt) }
                
                // å›¾è¡¨æ•°æ®
                chartData: {
                    vAngles: [], // å‚ç›´è§’åº¦ (Xè½´)
                    c0Values: [], // C0å¹³é¢çš„å…‰å¼º
                    c90Values: [], // C90å¹³é¢çš„å…‰å¼º (å¯èƒ½ä¸ºç©º)
                    maxCandela: 0
                },
                iesSymmetryInfo: ''
            }
        },
        watch: {
            // ç›‘å¬ tab åˆ‡æ¢ï¼Œåˆ‡æ¢åˆ°å›¾è¡¨ tab æ—¶éœ€è¦é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°ä»¥é€‚åº”å®¹å™¨
            currentTab(newTab) {
                if (newTab === 'polar' || newTab === 'cartesian') {
                    nextTick(() => {
                        Plotly.relayout('polarPlot', { autosize: true });
                        Plotly.relayout('cartesianPlot', { autosize: true });
                    });
                }
            },
            // ç›‘å¬å€æ•°å˜åŒ–ï¼Œå®æ—¶æ›´æ–°å›¾è¡¨ (ä»… IES)
            'parsedData.multiplier'(newVal) {
                 if(this.fileType === 'ies' && newVal) {
                    this.updateChartsWithMultiplier(newVal);
                 }
            }
        },
        methods: {
            handleFileSelect(event) { const file = event.target.files[0]; if (file) this.processFile(file); },
            handleDrop(event) { const file = event.dataTransfer.files[0]; if (file) this.processFile(file); },
            
            processFile(file) {
                this.fileName = file.name
                const ext = file.name.split('.').pop().toLowerCase()
                const reader = new FileReader()
                reader.onload = (e) => {
                    this.rawContent = e.target.result
                    this.rawLines = this.rawContent.split(/\r?\n/)
                    if (ext === 'ies') {
                        this.fileType = 'ies'
                        if(this.parseIESDeep()) { this.drawCharts(); }
                    } else if (ext === 'ldt') {
                        this.fileType = 'ldt'
                        if(this.parseLDTDeep()) { this.drawCharts(); }
                    } else {
                        alert("ä»…æ”¯æŒ .ies å’Œ .ldt æ–‡ä»¶"); this.parsedData = null;
                    }
                    this.currentTab = 'editor'; // é‡ç½®åˆ°ç¼–è¾‘é¡µ
                }
                reader.readAsText(file, 'ISO-8859-1')
            },

            // =========================================
            // æ·±åº¦è§£æ (Deep Parsing) - ä¸ºå›¾è¡¨æå–æ•°æ®
            // =========================================

            parseLDTDeep() {
                const lines = this.rawLines;
                if (lines.length < 30) { alert("æ–‡ä»¶è¿‡çŸ­æˆ–æŸå"); return false; }

                // 1. æå–åŸºç¡€ä¿¡æ¯
                this.parsedData = {
                    manufacturer: lines[0].trim(),
                    catalogNumber: lines[1].trim(),
                    luminaireName: lines[2].trim(),
                    symmetryIndicator: parseInt(lines[3]), // LDTå¯¹ç§°æ€§
                    watts: parseFloat(lines[26]),
                    totalFlux: parseInt(lines[28]),
                    cct: '', cri: '', multiplier: 1.0
                };

                // 2. æå–å›¾è¡¨æ•°æ®
                try {
                    const numV = parseInt(lines[30]); // å‚ç›´è§’åº¦æ•°é‡
                    const numH = parseInt(lines[31]); // æ°´å¹³è§’åº¦æ•°é‡
                    let currentLine = 42; // æ•°æ®èµ·å§‹è¡Œ

                    // è¯»å–å‚ç›´è§’åº¦ (V-Angles / Gamma)
                    this.chartData.vAngles = [];
                    for(let i=0; i<numV; i++) {
                        this.chartData.vAngles.push(parseFloat(lines[currentLine++]));
                    }

                    // è¯»å–æ°´å¹³è§’åº¦ (H-Angles / C-Planes) - LDTæ ‡å‡†é€šå¸¸ä¸æ˜ç¡®åˆ—å‡ºHè§’åº¦å€¼ï¼Œè€Œæ˜¯å‡è®¾å‡åˆ†
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦è¯»å–ç¬¬ä¸€ä¸ªå¹³é¢(C0)å’Œä¸­é—´å¹³é¢(C90)çš„æ•°æ®
                    
                    // LDTæ•°æ®å­˜å‚¨æ–¹å¼ï¼šå…ˆæ˜¯C0å¹³é¢çš„æ‰€æœ‰Vè§’åº¦å…‰å¼ºï¼Œç„¶åæ˜¯ä¸‹ä¸€Cå¹³é¢çš„...
                    
                    // è¯»å– C0 å¹³é¢æ•°æ®
                    this.chartData.c0Values = [];
                    for(let i=0; i<numV; i++) {
                         this.chartData.c0Values.push(parseFloat(lines[currentLine++]));
                    }

                    // å°è¯•å°è¯•è¯»å– C90 å¹³é¢æ•°æ® (å¦‚æœå­˜åœ¨å¤šä¸ªå¹³é¢)
                    this.chartData.c90Values = [];
                    if (numH > 1) {
                        // è·³è¿‡ä¸­é—´å¹³é¢ï¼Œç²—ç•¥å®šä½åˆ° C90 é™„è¿‘
                        let c90Index = Math.floor(numH / 4); // å‡è®¾æ˜¯å››åˆ†å¯¹ç§°ï¼ŒC90åœ¨1/4å¤„
                        if (this.parsedData.symmetryIndicator === 1) c90Index = 0; // å·¦å³å¯¹ç§°ï¼Œåªæœ‰ C0-180

                        let skipRows = (c90Index - 1) * numV;
                        currentLine += skipRows;

                        if(currentLine + numV < lines.length && this.parsedData.symmetryIndicator !== 1) {
                             for(let i=0; i<numV; i++) {
                                this.chartData.c90Values.push(parseFloat(lines[currentLine++]));
                            }
                        }
                    }

                    this.calculateMaxCandela();

                } catch (e) {
                    console.error("LDTå›¾è¡¨æ•°æ®è§£æå¤±è´¥", e);
                    alert("æ— æ³•è§£æé…å…‰æ›²çº¿æ•°æ®ï¼Œå¯èƒ½æ–‡ä»¶æ ¼å¼ä¸æ ‡å‡†ã€‚ä»…å¯ç¼–è¾‘è¡¨å¤´ä¿¡æ¯ã€‚");
                }
                return true;
            },

            parseIESDeep() {
                 const lines = this.rawLines;
                 let data = { manufacturer: '', luminaireName: '', catalogNumber: '', watts: 0, multiplier: 1.0, cct: '', cri: '' };
                 
                 // 1. Header è§£æ
                 lines.forEach(line => {
                    if (line.startsWith('[')) {
                        if (line.includes('MANUFAC')) data.manufacturer = this.getIESValue(line)
                        if (line.includes('LUMCAT')) data.catalogNumber = this.getIESValue(line)
                        if (line.includes('LUMINAIRE')) data.luminaireName = this.getIESValue(line)
                        if (line.includes('CCT') || line.includes('COLORTEMP')) data.cct = this.getIESValue(line)
                        if (line.includes('CRI') || line.includes('RA')) data.cri = this.getIESValue(line)
                    }
                });

                // 2. å®šä½æ•°æ®åŒº
                let tiltIndex = lines.findIndex(l => l.trim().startsWith('TILT='));
                if(tiltIndex === -1) { alert("æ— æ•ˆçš„ IES æ–‡ä»¶ (æœªæ‰¾åˆ° TILT)"); return false; }

                try {
                    // å°† TILT åçš„æ‰€æœ‰å†…å®¹åˆå¹¶ä¸ºä¸€ä¸ªå¤§å­—ç¬¦ä¸²æµè¿›è¡Œè§£æ
                    // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æµå¼è§£æå™¨
                    let dataStreamStr = lines.slice(tiltIndex + 1).join(" ");
                    // æ¸…ç†å¤šä½™ç©ºæ ¼
                    let tokens = dataStreamStr.trim().split(/\s+/).map(Number);
                    let p = 0; // æŒ‡é’ˆ

                    // è·³è¿‡ TILT æ–‡ä»¶å (å¦‚æœ TILT=INCLUDE) - ç®€åŒ–å¤„ç†ï¼Œå‡è®¾æ˜¯ NONE æˆ–è€…æ–‡ä»¶åå ä¸€ä¸ªtoken
                    if (lines[tiltIndex].includes("INCLUDE")) p++;

                    // è¯»å–å‚æ•°è¡Œ
                    // #Lamps, Lumens, Multiplier, V-Ang#, H-Ang#, Type, Units, Width, Len, Height
                    const numLamps = tokens[p++];
                    const lumensPerLamp = tokens[p++];
                    data.multiplier = tokens[p++];
                    const numV = tokens[p++];
                    const numH = tokens[p++];
                    p += 5; // è·³è¿‡ Type, Units, Dimensions

                    // è·³è¿‡ Ballast Factor, Input Watts (Wattageåœ¨è¿™é‡Œ)
                    p += 1;
                    data.watts = tokens[p++];
                    p += 1; // Skip another value

                    // è¯»å–è§’åº¦
                    this.chartData.vAngles = tokens.slice(p, p + numV);
                    p += numV;
                    const hAngles = tokens.slice(p, p + numH);
                    p += numH;

                    // ç¡®å®š IES å¯¹ç§°æ€§ä¿¡æ¯
                    const lastH = hAngles[hAngles.length -1];
                    if (lastH === 0) this.iesSymmetryInfo = "æ—‹è½¬å¯¹ç§° (Rotational)";
                    else if (lastH === 90) this.iesSymmetryInfo = "å››åˆ†å¯¹ç§° (Quadrilateral, 0-90Â°)";
                    else if (lastH === 180) this.iesSymmetryInfo = "å·¦å³å¯¹ç§° (Bilateral, 0-180Â°)";
                    else if (lastH === 360) this.iesSymmetryInfo = "éå¯¹ç§° (Asymmetric, 0-360Â°)";
                    else this.iesSymmetryInfo = `è‡ªå®šä¹‰èŒƒå›´ (0-${lastH}Â°)`;

                    // è¯»å–å…‰å¼ºæ•°æ®çŸ©é˜µ (Candela Matrix)
                    // IES æ•°æ®æ’åˆ—ï¼šå…ˆåˆ—å‡ºæ‰€æœ‰ H å¹³é¢åœ¨ç¬¬ä¸€ä¸ª V è§’åº¦çš„å…‰å¼ºï¼Œå†åˆ—å‡ºç¬¬äºŒä¸ª V è§’åº¦çš„...
                    
                    this.chartData.c0Values = [];
                    this.chartData.c90Values = [];

                    let c0Index = hAngles.indexOf(0);
                    let c90Index = hAngles.indexOf(90); // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ C90

                    for (let v = 0; v < numV; v++) {
                        // æ¯ä¸€è¡Œ V è§’åº¦å¯¹åº” numH ä¸ªæ°´å¹³è§’åº¦çš„æ•°æ®
                        let rowStart = p + v * numH;
                        if (c0Index !== -1) {
                            this.chartData.c0Values.push(tokens[rowStart + c0Index]);
                        }
                        if (c90Index !== -1) {
                            this.chartData.c90Values.push(tokens[rowStart + c90Index]);
                        }
                    }
                    
                    this.parsedData = data;
                    // åº”ç”¨åˆå§‹çš„å€å¢å› å­åˆ°å›¾è¡¨æ•°æ®
                    this.updateChartsWithMultiplier(data.multiplier);

                } catch(e) {
                    console.error("IESè§£æå¤±è´¥", e);
                    alert("IES æ•°æ®åŒºè§£æå¤±è´¥ï¼Œå¯èƒ½æ ¼å¼ä¸æ ‡å‡†ã€‚");
                    this.parsedData = data; // ä»ç„¶å…è®¸ç¼–è¾‘è¡¨å¤´
                }
                return true;
            },

            getIESValue(line) { return line.substring(line.indexOf(']') + 1).trim() },
            
            calculateMaxCandela() {
                 let max0 = Math.max(...(this.chartData.c0Values || [0]));
                 let max90 = Math.max(...(this.chartData.c90Values || [0]));
                 this.chartData.maxCandela = Math.max(max0, max90);
            },

            updateChartsWithMultiplier(multiplier) {
                // IESå›¾è¡¨æ•°æ®å­˜å‚¨çš„æ˜¯åŸå§‹å€¼ï¼Œæ˜¾ç¤ºæ—¶ä¹˜å€æ•°
                this.calculateMaxCandela();
                this.drawCharts(multiplier);
            },

            // =========================================
            // ç»˜å›¾é€»è¾‘ (Plotly.js)
            // =========================================
            drawCharts(multiplier = 1.0) {
                nextTick(() => {
                    this.drawPolar(multiplier);
                    this.drawCartesian(multiplier);
                });
            },

            drawPolar(multiplier) {
                const vRad = this.chartData.vAngles.map(a => a * Math.PI / 180); // è½¬å¼§åº¦
                // åº”ç”¨å€æ•°
                const c0 = this.chartData.c0Values.map(v => v * multiplier);
                const c90 = this.chartData.c90Values.map(v => v * multiplier);
                const maxVal = this.chartData.maxCandela * multiplier * 1.05; //ç¨å¾®ç•™ç‚¹è¾¹è·

                // æ„é€ é•œåƒæ•°æ®ä»¥å½¢æˆå®Œæ•´çš„åœ† (å¯¹äº 0-180 çš„æ•°æ®)
                const vFull = [...vRad, ...vRad.map(a => -a).reverse()];
                const c0Full = [...c0, ...c0.reverse()];
                const c90Full = [...c90, ...c90.reverse()];

                const traces = [
                    {
                        type: 'scatterpolar',
                        mode: 'lines',
                        r: c0Full, theta: vFull.map(r => r * 180 / Math.PI), // è½¬å›è§’åº¦ç»™ Plotly
                        name: 'C0/180', line: { color: 'red', width: 2 }
                    }
                ];
                if(c90.length > 0 && this.parsedData.symmetryIndicator !== 1) {
                    traces.push({
                        type: 'scatterpolar', mode: 'lines',
                        r: c90Full, theta: vFull.map(r => r * 180 / Math.PI),
                        name: 'C90/270', line: { color: 'blue', width: 2 }
                    });
                }

                const layout = {
                    polar: {
                        radialaxis: { visible: true, range: [0, maxVal] },
                        angularaxis: { 
                            direction: "clockwise",
                            rotation: 90, // 0åº¦æœä¸‹
                            tickmode: 'array',
                            tickvals: [0, 30, 60, 90, 120, 150, 180, -30, -60, -90, -120, -150],
                            ticktext: ['0Â°', '30Â°', '60Â°', '90Â°', '120Â°', '150Â°', '180Â°', '330Â°', '300Â°', '270Â°', '240Â°', '210Â°']
                        } 
                    },
                    margin: { t: 30, b: 30, l: 30, r: 30 },
                    showlegend: false // ä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹è¯´æ˜
                };
                Plotly.newPlot('polarPlot', traces, layout, {displayModeBar: false});
            },

            drawCartesian(multiplier) {
                const v = this.chartData.vAngles;
                 // åº”ç”¨å€æ•°
                const c0 = this.chartData.c0Values.map(v => v * multiplier);
                const c90 = this.chartData.c90Values.map(v => v * multiplier);

                const traces = [
                    { x: v, y: c0, type: 'scatter', mode: 'lines', name: 'C0', line: { color: 'red' } }
                ];
                 if(c90.length > 0 && this.parsedData.symmetryIndicator !== 1) {
                    traces.push({ x: v, y: c90, type: 'scatter', mode: 'lines', name: 'C90', line: { color: 'blue' } });
                }

                const layout = {
                    xaxis: { title: 'å‚ç›´è§’åº¦ Î³ (åº¦)', range: [0, 180] },
                    yaxis: { title: 'å…‰å¼º I (cd)' },
                    margin: { t: 30, b: 50, l: 60, r: 30 },
                    showlegend: true
                };
                Plotly.newPlot('cartesianPlot', traces, layout, {displayModeBar: false});
            },

            // =========================================
            // ä¸‹è½½ç”Ÿæˆ (Generate & Download)
            // =========================================
            downloadFile() {
                let content = this.fileType === 'ies' ? this.generateIES() : this.generateLDT();
                const blob = new Blob([content], { type: 'text/plain' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = 'mod_' + this.fileName
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },

            generateIES() {
                // IES ç”Ÿæˆé€»è¾‘ä¸ä¹‹å‰ç›¸åŒï¼Œä¸»è¦æ›´æ–°Headerå’ŒMultiplier
                let newLines = [...this.rawLines]
                const d = this.parsedData
                this.updateIESLine(newLines, 'MANUFAC', d.manufacturer)
                this.updateIESLine(newLines, 'LUMINAIRE', d.luminaireName)
                this.updateIESLine(newLines, 'LUMCAT', d.catalogNumber)
                if (d.cct) this.updateIESLine(newLines, 'CCT', d.cct, true)
                if (d.cri) this.updateIESLine(newLines, 'CRI', d.cri, true)

                let tiltIndex = newLines.findIndex(l => l.trim().startsWith('TILT='))
                if (tiltIndex !== -1) {
                     // ç®€æ˜“æ›¿æ¢ Multiplierã€‚è¿™å‡è®¾ TILT åå‡ è¡Œæ•°æ®ç»“æ„æ ‡å‡†ã€‚
                     // æ‰¾åˆ° TILT ååŒ…å«æ•°å­—çš„è¡Œï¼Œæ›¿æ¢ç¬¬3ä¸ªæ•°å­—ã€‚
                     let p = tiltIndex + 1;
                     if (newLines[tiltIndex].includes("INCLUDE")) p++; // è·³è¿‡ potential filename
                     // å¯»æ‰¾ç¬¬ä¸€è¡Œæœ‰æ•ˆæ•°æ®
                     while(p < newLines.length && !newLines[p].trim().match(/^\d/)) p++;
                     
                     if(p < newLines.length) {
                        let tokens = newLines[p].trim().split(/\s+/);
                        if (tokens.length >= 3) {
                            tokens[2] = d.multiplier.toFixed(4); // å†™å…¥æ–°çš„å€æ•°
                            newLines[p] = " " + tokens.join(" "); // ä¿æŒä¸€ç‚¹ç¼©è¿›
                        }
                     }
                }
                return newLines.join('\n')
            },
             updateIESLine(lines, key, value, forceAdd = false) {
                const tag = `[${key}]`
                const idx = lines.findIndex(l => l.startsWith(tag))
                if (idx !== -1) lines[idx] = `${tag} ${value}`
                else if (forceAdd && value) lines.splice(1, 0, `${tag} ${value}`)
            },

            generateLDT() {
                // LDT ç”Ÿæˆé€»è¾‘ï¼Œå¢åŠ å¯¹ç§°æ€§ä¿®æ”¹
                let newLines = [...this.rawLines]
                const d = this.parsedData
                newLines[0] = d.manufacturer
                newLines[1] = d.catalogNumber
                newLines[2] = d.luminaireName
                if (d.cct || d.cri) {
                    let extra = ` (${d.cct} ${d.cri})`.trim()
                    if (!newLines[2].includes(extra)) newLines[2] += extra
                }
                // ä¿®æ”¹å¯¹ç§°æ€§ (Line 3 / Index 3)
                newLines[3] = d.symmetryIndicator.toString();
                newLines[26] = d.watts.toString()
                newLines[28] = d.totalFlux.toString()
                return newLines.join('\r\n')
            }
        }
    }).mount('#app')
</script>

</body>
</html>
