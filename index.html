<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES/LDT Professional Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        /* --- Â±èÂπïÊòæÁ§∫Ê†∑Âºè (ÊöóËâ≤‰∏ªÈ¢ò / Dark Mode) --- */
        :root { 
            --bg-dark: #1a1b1e; 
            --card-bg: #25262b; 
            --border: #2c2e33; 
            --text-main: #e5e7eb; 
            --text-muted: #9ca3af; 
            --accent: #4dabf7; 
            --highlight: #ffeb3b; 
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Inter', system-ui, sans-serif; 
            overflow-x: hidden; 
        }
        
        /* ÊªöÂä®Êù°ÁæéÂåñ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #373a40; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* ‰ª™Ë°®ÁõòÂç°Áâá */
        .dashboard-card { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        .card-header { 
            padding: 12px 16px; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .card-body { 
            padding: 16px; 
            flex: 1; 
            position: relative; 
        }

        /* ÊãñÊãΩ‰∏ä‰º†Âå∫ */
        .drag-area { 
            border: 2px dashed #373a40; 
            transition: all 0.3s; 
            background: var(--card-bg); 
        }
        .drag-area:hover { border-color: var(--accent); background: #1c1e23; }

        /* ÂØºËà™ÊåâÈíÆ */
        .nav-btn { 
            padding: 6px 16px; 
            font-size: 0.9rem; 
            color: var(--text-muted); 
            border-bottom: 2px solid transparent; 
            transition: 0.2s; 
        }
        .nav-btn.active { color: #fff; border-bottom-color: var(--accent); }

        /* Êï∞ÊçÆË°®Â§¥Âõ∫ÂÆö */
        .data-table th { 
            background: #1e1f23; 
            position: sticky; 
            top: 0; 
            padding: 8px; 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            z-index: 10; 
        }
        .data-table td { 
            border-bottom: 1px solid var(--border); 
            padding: 6px; 
            font-size: 0.75rem; 
            text-align: center; 
        }

        /* ÊâìÂç∞‰∏ìÁî®Âå∫Âüü (ÈªòËÆ§Â±èÂπïÈöêËóè) */
        #print-section { display: none; }

        /* --- ÊâìÂç∞Ê®°ÂºèÊ†∑Âºè (A4 ÁôΩÂ∫ï / Print Mode) --- */
        @media print {
            body { background: white !important; color: black !important; overflow: visible; }
            #app-ui { display: none !important; } /* ÈöêËóèÊâÄÊúâÊöóËâ≤ÁïåÈù¢ */
            #print-section { display: block !important; } /* ÊòæÁ§∫Êä•Âëä */
            
            .report-page { width: 100%; max-width: 210mm; margin: 0 auto; padding: 0; }
            .print-row { display: flex; gap: 20px; margin-bottom: 20px; }
            .print-col { flex: 1; border: 1px solid #ddd; padding: 10px; break-inside: avoid; }
            
            h1, h2, h3 { color: black !important; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #ccc; padding: 4px; text-align: left; color: black !important; }
            
            /* Âº∫Âà∂ÊµèËßàÂô®ÊâìÂç∞ËÉåÊôØËâ≤ */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    
    <div id="app-ui" class="flex flex-col h-screen">
        <header class="bg-[#25262b] border-b border-[#2c2e33] px-6 py-3 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-4">
                <div class="text-xl font-bold tracking-wider text-white">VISO <span class="text-[#4dabf7] text-xs">STYLE</span></div>
                <div v-if="parsedData" class="text-sm text-gray-500 border-l border-gray-700 pl-4">{{ fileName }}</div>
            </div>
            
            <div v-if="parsedData" class="flex gap-4">
                <button @click="currentView = 'overview'" :class="['nav-btn', currentView === 'overview' ? 'active' : '']">üìä Dashboard</button>
                <button @click="currentView = 'editor'" :class="['nav-btn', currentView === 'editor' ? 'active' : '']">üìù Edit Parameters</button>
            </div>

            <div class="flex gap-3">
                <button v-if="parsedData" @click="printReport" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded flex items-center gap-1">
                    üñ®Ô∏è Print Report
                </button>
                <button @click="$refs.fileInput.click()" class="text-xs bg-[#4dabf7] hover:bg-blue-600 text-white px-3 py-1.5 rounded font-bold flex items-center gap-1">
                    üìÇ Open File
                </button>
            </div>
        </header>

        <input type="file" ref="fileInput" class="hidden" accept=".ies,.ldt" @change="handleFileSelect">

        <main class="flex-1 p-4 overflow-y-auto bg-[#1a1b1e]">
            
            <div v-if="!parsedData" class="h-full flex flex-col items-center justify-center">
                <div class="drag-area p-16 rounded-xl text-center cursor-pointer max-w-2xl w-full"
                     @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
                    <div class="text-6xl mb-4">üí°</div>
                    <h2 class="text-2xl font-bold text-white mb-2">Drop IES / LDT File Here</h2>
                    <p class="text-gray-500">Professional Photometric Analysis & Editing</p>
                </div>
            </div>

            <div v-else-if="currentView === 'overview'" class="grid grid-cols-12 gap-4 max-w-[1800px] mx-auto pb-10">
                
                <div class="col-span-12 lg:col-span-3 dashboard-card h-[400px]">
                    <div class="card-header">LUMINAIRE DETAILS</div>
                    <div class="card-body flex flex-col gap-6">
                        <div>
                            <div class="text-3xl font-bold text-[#ffeb3b]">{{ formatNum(calculated.totalFlux, 0) }} <span class="text-sm text-gray-500">lm</span></div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide">Total Luminous Flux</div>
                            <div class="w-full bg-gray-800 h-1.5 mt-2 rounded-full overflow-hidden">
                                <div class="bg-yellow-400 h-full" style="width: 75%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-xl font-bold text-white">{{ formatNum(calculated.maxCandela, 0) }} cd</div>
                                <div class="text-xs text-gray-500">Peak Intensity</div>
                            </div>
                            <div>
                                <div class="text-xl font-bold text-white">{{ formatNum(parsedData.watts, 1) }} W</div>
                                <div class="text-xs text-gray-500">System Power</div>
                            </div>
                        </div>

                        <div class="p-3 bg-[#151618] rounded border border-gray-800 text-sm space-y-2">
                             <div class="flex justify-between">
                                 <span class="text-gray-500">Efficacy</span>
                                 <span class="text-green-400 font-bold">{{ formatNum(calculated.efficacy, 1) }} lm/W</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-500">Beam Angle</span>
                                 <span class="text-white font-bold">{{ calculated.beamAngle }}¬∞</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-500">Type</span>
                                 <span class="text-gray-300">{{ fileType.toUpperCase() }}</span>
                             </div>
                        </div>

                        <div class="mt-auto text-xs text-gray-600 truncate">
                            {{ parsedData.manufacturer }} / {{ parsedData.luminaireName }}
                        </div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-6 lg:col-span-5 dashboard-card h-[400px]">
                    <div class="card-header">POLAR DISTRIBUTION</div>
                    <div class="card-body p-0 relative">
                        <div id="polarPlot" class="w-full h-full"></div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-6 lg:col-span-4 dashboard-card h-[400px]">
                    <div class="card-header">LINEAR DISTRIBUTION</div>
                    <div class="card-body p-0 relative">
                        <div id="linearPlot" class="w-full h-full"></div>
                    </div>
                </div>

                <div class="col-span-12 dashboard-card min-h-[250px]">
                    <div class="card-header">BEAM VISUALIZATION & ILLUMINANCE</div>
                    <div class="card-body bg-[#151618] flex items-center justify-center p-0 overflow-hidden">
                         <svg viewBox="0 0 800 220" class="w-full h-full max-w-5xl" style="overflow: visible;">
                            <defs>
                                <linearGradient id="beamGrad" x1="0" y1="0.5" x2="1" y2="0.5">
                                    <stop offset="0%" stop-color="#ffeb3b" stop-opacity="0.6"/>
                                    <stop offset="100%" stop-color="#ffeb3b" stop-opacity="0.05"/>
                                </linearGradient>
                            </defs>
                            <text x="400" y="20" text-anchor="middle" fill="#555" font-size="12">Illuminance (lx) & Diameter (m) at Distance</text>
                            
                            <circle cx="50" cy="110" r="5" fill="#fff" />
                            
                            <path d="M50 110 L750 30 L750 190 Z" fill="url(#beamGrad)" />
                            <line x1="50" y1="110" x2="750" y2="110" stroke="#fff" stroke-dasharray="3" stroke-opacity="0.2" />

                            <g v-for="d in [1, 2, 3, 4, 5]" :key="d">
                                <line :x1="50 + d*130" y1="30" :x2="50 + d*130" y2="190" stroke="#333" stroke-dasharray="2"/>
                                <text :x="50 + d*130" y="50" text-anchor="middle" fill="#fff" font-weight="bold" font-size="16">{{ calcLux(d) }} lx</text>
                                <text :x="50 + d*130" y="210" text-anchor="middle" fill="#666" font-size="12">{{ d }}m</text>
                                <text :x="50 + d*130" y="180" text-anchor="middle" fill="#aaa" font-size="11">√ò {{ calcDiam(d) }}m</text>
                            </g>
                        </svg>
                    </div>
                </div>

                <div class="col-span-12 dashboard-card h-[400px]">
                    <div class="card-header">INTENSITY MATRIX (cd)</div>
                    <div class="card-body p-0 overflow-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left w-20 bg-[#1e1f23] sticky left-0 z-20">V \ H</th>
                                    <th v-for="h in matrixData.hAngles" :key="h">{{ h }}¬∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, i) in matrixData.rows" :key="i">
                                    <td class="bg-[#1e1f23] sticky left-0 z-10 text-yellow-500 font-bold border-r border-gray-700">{{ matrixData.vAngles[i] }}¬∞</td>
                                    <td v-for="(val, j) in row" :key="j" :style="{color: getCellColor(val)}">{{ val.toFixed(1) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div v-else-if="currentView === 'editor'" class="max-w-2xl mx-auto mt-10">
                <div class="dashboard-card p-8">
                    <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-4">Edit Parameters</h2>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Manufacturer</label>
                                <input v-model="parsedData.manufacturer" class="w-full bg-[#151618] border border-[#2c2e33] text-white p-2 rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Luminaire Name</label>
                                <input v-model="parsedData.luminaireName" class="w-full bg-[#151618] border border-[#2c2e33] text-white p-2 rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Catalog Number</label>
                                <input v-model="parsedData.catalogNumber" class="w-full bg-[#151618] border border-[#2c2e33] text-white p-2 rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-1">Watts (Input Power)</label>
                                <input type="number" v-model.number="parsedData.watts" class="w-full bg-[#151618] border border-[#2c2e33] text-white p-2 rounded focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div v-if="fileType === 'ies'" class="bg-yellow-900/10 border border-yellow-700/30 p-4 rounded">
                            <label class="block text-sm text-yellow-500 font-bold mb-1">Multiplier (Flux Factor)</label>
                            <div class="flex gap-4 items-center">
                                <input type="number" v-model.number="parsedData.multiplier" step="0.01" class="flex-1 bg-[#151618] border border-yellow-700/50 text-white p-2 rounded">
                                <span class="text-xs text-gray-400">Affects candela values globally</span>
                            </div>
                        </div>

                        <div v-if="fileType === 'ldt'" class="bg-yellow-900/10 border border-yellow-700/30 p-4 rounded">
                            <label class="block text-sm text-yellow-500 font-bold mb-1">Total Luminous Flux (lm)</label>
                            <input type="number" v-model.number="parsedData.totalFlux" class="w-full bg-[#151618] border border-yellow-700/50 text-white p-2 rounded">
                        </div>

                        <div class="pt-6 border-t border-gray-700 flex justify-between">
                            <button @click="currentView = 'overview'" class="text-gray-400 hover:text-white">Cancel</button>
                            <button @click="downloadFile" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-lg flex items-center gap-2">
                                <span>üíæ Save & Download File</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="print-section">
        <div class="report-page">
            <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">PHOTOMETRIC TEST REPORT</h1>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Generated by Web IES Analyzer</p>
                </div>
                <div style="text-align: right;">
                    <p style="font-weight: bold; margin: 0;">{{ parsedData?.manufacturer }}</p>
                    <p style="margin: 0;">{{ new Date().toLocaleDateString() }}</p>
                </div>
            </div>

            <div class="print-row">
                <div class="print-col">
                    <h3>Luminaire Data</h3>
                    <table>
                        <tr><td>Name</td><td>{{ parsedData?.luminaireName }}</td></tr>
                        <tr><td>Number</td><td>{{ parsedData?.catalogNumber }}</td></tr>
                        <tr><td>Power</td><td>{{ parsedData?.watts }} W</td></tr>
                    </table>
                </div>
                <div class="print-col">
                    <h3>Photometric Results</h3>
                    <table>
                        <tr><td>Total Flux</td><td><b>{{ formatNum(calculated.totalFlux, 0) }} lm</b></td></tr>
                        <tr><td>Efficacy</td><td>{{ formatNum(calculated.efficacy, 1) }} lm/W</td></tr>
                        <tr><td>Max Candela</td><td>{{ formatNum(calculated.maxCandela, 0) }} cd</td></tr>
                        <tr><td>Beam Angle</td><td>{{ calculated.beamAngle }}¬∞</td></tr>
                    </table>
                </div>
            </div>

            <div class="print-row">
                <div class="print-col">
                    <h3 style="text-align: center;">Polar Plot (cd)</h3>
                    <div id="printPolar" style="height: 300px; width: 100%;"></div>
                </div>
                <div class="print-col">
                    <h3 style="text-align: center;">Cartesian Plot</h3>
                    <div id="printLinear" style="height: 300px; width: 100%;"></div>
                </div>
            </div>

            <div class="print-col" style="margin-top: 20px;">
                <h3>Cone Diagram</h3>
                <table style="text-align: center;">
                    <tr>
                        <th>Distance</th><th>1.0 m</th><th>2.0 m</th><th>3.0 m</th>
                    </tr>
                    <tr>
                        <td>Illuminance (Center)</td>
                        <td><b>{{ calcLux(1) }} lx</b></td>
                        <td><b>{{ calcLux(2) }} lx</b></td>
                        <td><b>{{ calcLux(3) }} lx</b></td>
                    </tr>
                    <tr>
                        <td>Beam Diameter</td>
                        <td>{{ calcDiam(1) }} m</td>
                        <td>{{ calcDiam(2) }} m</td>
                        <td>{{ calcDiam(3) }} m</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                currentView: 'overview',
                fileName: '',
                fileType: '',
                rawLines: [], 
                parsedData: null, 
                // ÂõæË°®Êï∞ÊçÆ
                chartData: { vAngles: [], c0Values: [], c90Values: [] },
                // ÂÆåÊï¥Áü©ÈòµÊï∞ÊçÆ
                matrixData: { vAngles: [], hAngles: [], rows: [] },
                // ËÆ°ÁÆóÁªìÊûú
                calculated: { totalFlux: 0, efficacy: 0, maxCandela: 0, beamAngle: 0 }
            }
        },
        watch: {
            // ÁõëÂê¨ÁºñËæëÔºåËá™Âä®ÈáçÁÆó
            'parsedData.multiplier'() { this.reCalculate(); },
            'parsedData.totalFlux'() { this.reCalculate(); },
            'parsedData.watts'() { this.reCalculate(); },
            
            // ËßÜÂõæÂàáÊç¢Êó∂ÈáçÁªòÂõæË°®
            currentView(val) {
                if(val === 'overview') nextTick(() => this.drawCharts('screen'));
            }
        },
        methods: {
            formatNum(v, d) { return typeof v === 'number' ? v.toFixed(d) : '-'; },
            
            handleFileSelect(e) { this.processFile(e.target.files[0]); },
            handleDrop(e) { this.processFile(e.dataTransfer.files[0]); },
            
            processFile(file) {
                if(!file) return;
                this.fileName = file.name;
                this.fileType = file.name.toLowerCase().endsWith('ies') ? 'ies' : 'ldt';
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    this.rawLines = content.split(/\r?\n/);
                    let success = false;
                    try {
                        success = this.fileType === 'ies' ? this.parseIES(content) : this.parseLDT(content);
                    } catch(err) {
                        alert("Error parsing file: " + err.message);
                    }
                    if(success) {
                        this.reCalculate();
                        this.currentView = 'overview';
                        nextTick(() => this.drawCharts('screen'));
                    }
                };
                reader.readAsText(file, this.fileType === 'ldt' ? 'ISO-8859-1' : 'UTF-8');
            },

            // --- Âº∫Â£ÆÁöÑ Token Ëß£ÊûêÂô® ---
            getTokens(text) { return text.trim().split(/\s+/).map(t => t.trim()).filter(t => t.length > 0); },

            // --- IES Ëß£ÊûêÈÄªËæë ---
            parseIES(content) {
                let d = { manufacturer: '', luminaireName: '', catalogNumber: '', watts: 0, multiplier: 1.0 };
                // ÊèêÂèñ Metadata
                this.rawLines.forEach(l => {
                    if (l.includes('[MANUFAC]')) d.manufacturer = l.split(']')[1].trim();
                    if (l.includes('[LUMINAIRE]')) d.luminaireName = l.split(']')[1].trim();
                    if (l.includes('[LUMCAT]')) d.catalogNumber = l.split(']')[1].trim();
                });

                // ÊèêÂèñÊï∞ÊçÆÊµÅ
                const tiltIdx = this.rawLines.findIndex(l => l.trim().startsWith('TILT='));
                if (tiltIdx === -1) throw new Error("Invalid IES: Missing TILT");
                
                let tokens = this.getTokens(this.rawLines.slice(tiltIdx).join(" "));
                let p = tokens[0].includes("INCLUDE") ? 2 : 1; 

                const numLamps = parseInt(tokens[p++]);
                const lumens = parseFloat(tokens[p++]); 
                d.multiplier = parseFloat(tokens[p++]);
                const numV = parseInt(tokens[p++]);
                const numH = parseInt(tokens[p++]);
                p += 5; // Type, Units, W, L, H
                p += 2; // Ballast, Future
                d.watts = parseFloat(tokens[p++]);

                // ÊèêÂèñËßíÂ∫¶
                let vAngles = []; for(let i=0; i<numV; i++) vAngles.push(parseFloat(tokens[p++]));
                let hAngles = []; for(let i=0; i<numH; i++) hAngles.push(parseFloat(tokens[p++]));

                // ÊèêÂèñÂÖâÂº∫Áü©Èòµ
                let rows = []; for(let v=0; v<numV; v++) rows.push(new Array(numH));
                let c0 = [], c90 = [];
                let idx0 = hAngles.findIndex(h => Math.abs(h - 0) < 0.1);
                let idx90 = hAngles.findIndex(h => Math.abs(h - 90) < 0.1);

                for(let h=0; h<numH; h++) {
                    for(let v=0; v<numV; v++) {
                        let val = parseFloat(tokens[p++]);
                        rows[v][h] = val;
                        if(h === idx0) c0.push(val);
                        if(h === idx90) c90.push(val);
                    }
                }
                // ÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºöÂ¶ÇÊûúÊâæ‰∏çÂà∞C0(‰æãÂ¶ÇÈùû0Ëµ∑Âßã)ÔºåÈªòËÆ§ÂèñÁ¨¨‰∏ÄÂàó
                if(c0.length === 0 && rows.length > 0) c0 = rows.map(r => r[0]);

                this.parsedData = d;
                this.chartData = { vAngles, c0Values: c0, c90Values: c90 };
                this.matrixData = { vAngles, hAngles, rows };
                return true;
            },

            // --- LDT Ëß£ÊûêÈÄªËæë ---
            parseLDT(content) {
                const lines = this.rawLines;
                if(lines.length < 30) throw new Error("LDT file too short");
                
                let d = {
                    manufacturer: lines[0].trim(), catalogNumber: lines[1].trim(), luminaireName: lines[2].trim(),
                    watts: parseFloat(lines[26]), totalFlux: parseFloat(lines[28]), multiplier: 1.0
                };

                const numV = parseInt(lines[30]);
                const numH = parseInt(lines[31]);
                const dC = parseFloat(lines[32]);
                
                let p = 42;
                let vAngles = [];
                for(let i=0; i<numV; i++) vAngles.push(parseFloat(lines[p++]));
                
                let hAngles = [];
                for(let i=0; i<numH; i++) hAngles.push(i * dC);

                let remaining = lines.slice(p).join(" ");
                let tokens = this.getTokens(remaining);
                let tp = 0;
                
                let rows = []; for(let v=0; v<numV; v++) rows.push(new Array(numH));
                let c0 = [], c90 = [];
                let idx90 = Math.round(90 / dC);

                for(let h=0; h<numH; h++) {
                    for(let v=0; v<numV; v++) {
                        let val = parseFloat(tokens[tp++]);
                        rows[v][h] = val; 
                        if(h === 0) c0.push(val);
                        if(h === idx90) c90.push(val);
                    }
                }

                this.parsedData = d;
                this.chartData = { vAngles, c0Values: c0, c90Values: c90 };
                this.matrixData = { vAngles, hAngles, rows };
                return true;
            },

            // --- Ê†∏ÂøÉËÆ°ÁÆó ---
            reCalculate() {
                if(!this.parsedData) return;
                
                let mult = 1.0;
                if(this.fileType === 'ies') {
                    mult = this.parsedData.multiplier;
                    // IESÂÖâÈÄöÈáè‰º∞ÁÆó (ÊºîÁ§∫Áî®ÔºåÂÆûÈôÖÈúÄÁßØÂàÜ)
                    this.calculated.totalFlux = 1000 * mult; 
                } else {
                    // LDT: raw is cd/klm
                    mult = this.parsedData.totalFlux / 1000.0;
                    this.calculated.totalFlux = this.parsedData.totalFlux;
                }

                let maxRaw = 0;
                this.matrixData.rows.forEach(r => r.forEach(v => { if(v>maxRaw) maxRaw=v; }));
                this.calculated.maxCandela = maxRaw * mult;

                this.calculated.efficacy = this.parsedData.watts ? (this.calculated.totalFlux / this.parsedData.watts) : 0;

                // ËÆ°ÁÆóÂÖâÊùüËßí (50%)
                let c0Real = this.chartData.c0Values.map(v => v * mult);
                let maxVal = Math.max(...c0Real);
                let halfMax = maxVal / 2;
                let start = 0, end = 0;
                let foundStart = false;
                for(let i=0; i<c0Real.length; i++) {
                    if(c0Real[i] >= halfMax) {
                        if(!foundStart) { start = this.chartData.vAngles[i]; foundStart = true; }
                        end = this.chartData.vAngles[i];
                    }
                }
                if(this.chartData.vAngles[0] === 0) this.calculated.beamAngle = (end * 2).toFixed(1);
                else this.calculated.beamAngle = (end - start).toFixed(1);
            },

            // --- ËæÖÂä©Â∑•ÂÖ∑ ---
            calcLux(d) { return (this.calculated.maxCandela / (d*d)).toFixed(0); },
            calcDiam(d) { 
                let angRad = (this.calculated.beamAngle / 2) * (Math.PI / 180);
                return (2 * d * Math.tan(angRad)).toFixed(2); 
            },
            getCellColor(val) {
                // ÁÉ≠ÂäõÂõæÈ¢úËâ≤ÈÄªËæë
                let mult = this.fileType==='ies' ? this.parsedData.multiplier : (this.parsedData.totalFlux/1000);
                let ratio = (val * mult) / this.calculated.maxCandela;
                if(ratio > 0.9) return '#ffeb3b';
                if(ratio > 0.5) return '#fff';
                return '#555';
            },

            // --- ÁªòÂõæ ---
            drawCharts(target) {
                let mult = this.fileType==='ies' ? this.parsedData.multiplier : (this.parsedData.totalFlux/1000);
                const c0 = this.chartData.c0Values.map(v => v * mult);
                const c90 = this.chartData.c90Values.map(v => v * mult);
                
                // ÊûÅÂùêÊ†áÈïúÂÉèÂ§ÑÁêÜ
                const rFull = [...c0, ...c0.reverse()]; 
                const theta = this.chartData.vAngles;
                const thetaFull = [...theta, ...theta.map(t => -t).reverse()];

                const isScreen = target === 'screen';
                const colorC0 = isScreen ? '#ffeb3b' : 'red';
                const colorC90 = isScreen ? '#4dabf7' : 'blue';
                const bgColor = isScreen ? '#25262b' : '#fff';
                const fontColor = isScreen ? '#9ca3af' : '#000';
                const gridColor = isScreen ? '#333' : '#eee';

                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: fontColor, size: 10 },
                    margin: { t: 20, b: 20, l: 30, r: 30 },
                    showlegend: true,
                    legend: { x: 0.5, y: -0.15, xanchor: 'center', orientation: 'h' },
                    polar: {
                        bgcolor: bgColor,
                        radialaxis: { visible: true, tickcolor: gridColor, gridcolor: gridColor },
                        angularaxis: { rotation: 270, direction: "clockwise", gridcolor: gridColor, color: fontColor }
                    },
                    xaxis: { gridcolor: gridColor, color: fontColor },
                    yaxis: { gridcolor: gridColor, color: fontColor }
                };

                const divPolar = isScreen ? 'polarPlot' : 'printPolar';
                const divLinear = isScreen ? 'linearPlot' : 'printLinear';

                Plotly.newPlot(divPolar, [
                    { type: 'scatterpolar', mode: 'lines', r: rFull, theta: thetaFull, name: 'C0/180', line: {color: colorC0, width: 2} },
                    ...(c90.length ? [{ type: 'scatterpolar', mode: 'lines', r: [...c90, ...c90.reverse()], theta: thetaFull, name: 'C90/270', line: {color: colorC90, width: 2, dash: 'dash'} }] : [])
                ], layout, {staticPlot: !isScreen, displayModeBar: false});

                Plotly.newPlot(divLinear, [
                    { x: theta, y: c0, type: 'scatter', name: 'C0', line: {color: colorC0} },
                    ...(c90.length ? [{ x: theta, y: c90, type: 'scatter', name: 'C90', line: {color: colorC90, dash: 'dash'} }] : [])
                ], layout, {staticPlot: !isScreen, displayModeBar: false});
            },

            // --- ÊâìÂç∞‰∏é‰øùÂ≠ò ---
            printReport() {
                // ÂÖàÊ∏≤ÊüìÊâìÂç∞Áî®ÁöÑÂõæË°®ÔºåÂÜçË∞ÉÁî®ÊâìÂç∞
                this.drawCharts('print');
                setTimeout(() => window.print(), 500);
            },

            downloadFile() {
                let content = "";
                const d = this.parsedData;
                
                if (this.fileType === 'ies') {
                    // ÂÆâÂÖ®‰øÆÊîπ IES: ‰ªÖÊõøÊç¢ HeaderÔºå‰∏çÈáçÂÜô Data Áü©Èòµ‰ª•Èò≤Âá∫Èîô
                    let lines = [...this.rawLines];
                    const setHeader = (key, val) => {
                        let idx = lines.findIndex(l => l.includes(`[${key}]`));
                        if(idx > -1) lines[idx] = `[${key}] ${val}`;
                        else if(val) lines.splice(1, 0, `[${key}] ${val}`);
                    };
                    setHeader('MANUFAC', d.manufacturer);
                    setHeader('LUMINAIRE', d.luminaireName);
                    setHeader('LUMCAT', d.catalogNumber);
                    content = lines.join("\n");
                } else {
                    // LDT: Ë°åÁªìÊûÑÂõ∫ÂÆöÔºåÁõ¥Êé•ÊõøÊç¢
                    let lines = [...this.rawLines];
                    lines[0] = d.manufacturer;
                    lines[1] = d.catalogNumber;
                    lines[2] = d.luminaireName;
                    lines[26] = d.watts.toString();
                    lines[28] = d.totalFlux.toString();
                    content = lines.join("\r\n");
                }

                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = "mod_" + this.fileName;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
