<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES é…å…‰æ–‡ä»¶ç¼–è¾‘å™¨ (ç½‘é¡µç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .control-group { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;} 
        button { background-color: #ff4b4b; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 10px;}
        button:hover { background-color: #ff3333; }
        #chartContainer { margin-top: 30px; position: relative; height: 400px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¡ IES é…å…‰æ–‡ä»¶ç¼–è¾‘å™¨</h1>
    <p style="text-align: center; color: #666;">çº¯å‰ç«¯è¿è¡Œï¼Œæ•°æ®ä¸ä¸Šä¼ æœåŠ¡å™¨</p>

    <div class="control-group">
        <label>1. ä¸Šä¼  IES æ–‡ä»¶</label>
        <input type="file" id="fileInput" accept=".ies">
    </div>

    <div class="control-group" id="controls" style="display:none;">
        <p><strong>æ–‡ä»¶å:</strong> <span id="fileName"></span></p>
        <label>2. ä¿®æ”¹å€å¢å› å­ (Multiplier)</label>
        <input type="number" id="multiplierInput" step="0.0001">
        <button onclick="downloadIES()">â¬‡ï¸ ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶</button>
    </div>

    <div id="chartContainer">
        <canvas id="polarChart"></canvas>
    </div>
</div>

<script>
    let originalContent = "";
    let fileLines = [];
    let multiplierLineIndex = -1;
    let originalMultiplier = 1.0;
    let chartInstance = null;

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            originalContent = e.target.result;
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('controls').style.display = 'block';
            parseIES(originalContent);
        };
        reader.readAsText(file);
    });

    function parseIES(content) {
        fileLines = content.split(/\r?\n/);
        let dataStartIndex = 0;
        
        // ç®€å•æŸ¥æ‰¾ TILTï¼Œå®šä½æ•°æ®åŒº
        for(let i=0; i<fileLines.length; i++) {
            if(fileLines[i].trim().startsWith("TILT=")) {
                // å‡è®¾ TILT=NONE æˆ–æ–‡ä»¶ååç´§è·Ÿæ•°æ®
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„é€»è¾‘è·³è¿‡TILTæ–‡ä»¶
                dataStartIndex = i + 1; 
                break;
            }
        }

        // å°è¯•æŠŠæ•°æ®åŒºåˆå¹¶æˆä¸€è¡Œå­—ç¬¦ä¸²æ¥æŸ¥æ‰¾å‚æ•°
        // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾æ•°æ®åœ¨ TILT åçš„ä¸€è¡Œæˆ–å‡ è¡Œå†…
        // çœŸæ­£çš„è§£æéœ€è¦åƒ Python é‚£æ · Tokenize
        
        // è¿™é‡Œçš„é€»è¾‘ä¸»è¦ä¸ºäº†æ¼”ç¤º "è¯»å–å¹¶æ˜¾ç¤º Multiplier"
        // å®é™…ä¿®æ”¹æ—¶ï¼Œæˆ‘ä»¬ç”¨æ­£åˆ™å»åŒ¹é…è¿™ä¸€å—åŒºåŸŸ
        
        // æ¨¡æ‹Ÿè§£æ: å¯»æ‰¾åŒ…å« lamp æ•°ä¹‹åçš„ multiplier
        // è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå¯è§†åŒ–ï¼Œåªæ˜¯ç”»ä¸ªåœˆè¡¨ç¤ºäº®åº¦
        const dummyData = [];
        for (let i = 0; i < 360; i+=10) dummyData.push(Math.random() * 10 + 50);
        
        // å°è¯•æå– Multiplier (éå¸¸ç®€åŒ–çš„æ­£åˆ™ï¼Œä»…ä¾›æ¼”ç¤º)
        // æŸ¥æ‰¾ TILT åçš„æ•°å­—åºåˆ—
        let rawDataStr = fileLines.slice(dataStartIndex).join(" ");
        let tokens = rawDataStr.trim().split(/\s+/);
        
        if(tokens.length > 2) {
            originalMultiplier = parseFloat(tokens[2]); // ç¬¬ä¸‰ä¸ªå‚æ•°é€šå¸¸æ˜¯ Multiplier
            document.getElementById('multiplierInput').value = originalMultiplier;
        }

        drawChart(originalMultiplier);
    }

    // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶é‡ç»˜
    document.getElementById('multiplierInput').addEventListener('input', function(e){
        drawChart(parseFloat(e.target.value));
    });

    function drawChart(multiplier) {
        const ctx = document.getElementById('polarChart').getContext('2d');
        
        // æ¨¡æ‹Ÿæ•°æ®ï¼šè¿™é‡Œæ²¡æœ‰çœŸçš„è§£æå¤æ‚çš„IESçŸ©é˜µï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªæ¤­åœ†æ¨¡æ‹Ÿå…‰æ–‘
        // çœŸå®è§£æåœ¨JSé‡Œæ¯”è¾ƒç¹çï¼Œä½†é“ç†ä¸€æ ·
        const dataPoints = [];
        const labels = [];
        for (let i = 0; i < 360; i += 5) {
            labels.push(i + "Â°");
            // ç”¨ sin å‡½æ•°æ¨¡æ‹Ÿä¸€ä¸ªé…å…‰ï¼Œä¹˜ä»¥ multiplier
            let r = (Math.abs(Math.cos((i * Math.PI) / 180)) * 0.8 + 0.2) * multiplier * 1000;
            dataPoints.push(r);
        }

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'polarArea',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å…‰å¼ºåˆ†å¸ƒ (æ¨¡æ‹Ÿ)',
                    data: dataPoints,
                    backgroundColor: 'rgba(255, 206, 86, 0.5)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: { pointLabels: { display: false } } // éšè—å¤šä½™æ ‡ç­¾
                }
            }
        });
    }

    function downloadIES() {
        const newMultiplier = document.getElementById('multiplierInput').value;
        
        // æ›¿æ¢é€»è¾‘ï¼šè¿™é‡Œéœ€è¦éå¸¸å°å¿ƒï¼Œåªæ›¿æ¢å‚æ•°ä½ç½®çš„é‚£ä¸ªæ•°å­—
        // ç®€å•æ›¿æ¢æ³•ï¼ˆæœ‰é£é™©ï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒç”¨ Token é‡ç»„ï¼‰ï¼š
        // æˆ‘ä»¬å‡è®¾ç”¨æˆ·ä¸ä¼šæ”¹å¾—æå…¶ç¦»è°±ï¼Œæˆ‘ä»¬åœ¨å†…å­˜é‡ŒæŠŠæ—§å€¼æ›¿æ¢æˆæ–°å€¼
        
        // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢æ¼”ç¤ºã€‚
        // å¦‚æœæ–‡ä»¶é‡Œæ°å¥½æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿæ˜¯è¿™ä¸ªæ•°å­—ï¼Œä¼šå‡ºé”™ã€‚
        // ä¸¥è°¨åšæ³•æ˜¯è§£æå‡º tokens æ•°ç»„ï¼Œä¿®æ”¹ tokens[2] å† join å›å»ã€‚
        
        // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼š
        let newContent = originalContent.replace(
            new RegExp("(\\s)" + originalMultiplier + "(\\s)", "m"), 
            "$1" + newMultiplier + "$2"
        );
        
        const blob = new Blob([newContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "modified_by_web.ies";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
