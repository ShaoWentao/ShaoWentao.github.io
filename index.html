<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viso Style Photometric Editor Ultimate</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        :root { 
            --bg-dark: #141517; --card-bg: #1f2023; --border: #2c2e33; 
            --text-main: #e5e7eb; --text-muted: #9ca3af; 
            --accent: #4dabf7; --highlight: #ffeb3b; 
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; font-size: 13px; }
        
        /* ÊªöÂä®Êù° */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #373a40; border-radius: 3px; }
        
        /* Âç°Áâá */
        .dashboard-card { background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 0.8rem; font-weight: 700; color: #ced4da; letter-spacing: 0.5px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; background: #25262b; }
        .card-body { padding: 0; flex: 1; position: relative; }

        /* ÊãñÊãΩÂå∫ */
        .drag-area { border: 2px dashed #373a40; transition: all 0.3s; background: var(--card-bg); }
        .drag-area:hover { border-color: var(--accent); background: #25262b; }

        /* ÊåâÈíÆ */
        .btn { padding: 4px 12px; border-radius: 4px; font-weight: 600; transition: 0.2s; font-size: 0.75rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #339af0; }
        .btn-outline { border: 1px solid #373a40; color: #adb5bd; }
        .btn-outline:hover { border-color: var(--accent); color: white; }

        /* Ë°®Ê†º */
        .data-table th { background: #25262b; position: sticky; top: 0; padding: 6px; color: var(--text-muted); font-size: 0.7rem; z-index: 10; }
        .data-table td { border-bottom: 1px solid var(--border); padding: 4px; font-size: 0.7rem; text-align: center; }
        
        /* ÊâìÂç∞Ê®°Âºè */
        @media print {
            body { background: white !important; color: black !important; }
            #app-ui { display: none !important; }
            #print-section { display: block !important; }
            .report-page { width: 100%; max-width: 210mm; margin: 0 auto; padding: 10mm; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            h1 { font-size: 24px; font-weight: bold; }
        }
        #print-section { display: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    
    <div id="app-ui" class="flex flex-col h-screen">
        <header class="bg-[#1f2023] border-b border-[#2c2e33] px-4 py-2 flex justify-between items-center flex-shrink-0 z-50">
            <div class="flex items-center gap-3">
                <div class="font-bold text-lg tracking-wider text-white">VISO <span class="text-[#4dabf7] text-xs align-top">EDITOR</span></div>
                <div v-if="parsedData" class="text-xs text-gray-500 border-l border-gray-600 pl-3">{{ fileName }}</div>
            </div>
            
            <div v-if="parsedData" class="flex bg-[#141517] rounded p-1 gap-1">
                <button @click="currentView='overview'" :class="['btn', currentView==='overview'?'btn-primary':'text-gray-500 hover:text-white']">Dashboard</button>
                <button @click="currentView='editor'" :class="['btn', currentView==='editor'?'btn-primary':'text-gray-500 hover:text-white']">Editor</button>
            </div>

            <div class="flex gap-2">
                <button v-if="parsedData" @click="printReport" class="btn btn-outline">üñ®Ô∏è Report</button>
                <button @click="$refs.fileInput.click()" class="btn btn-outline border-blue-900 text-blue-400 hover:bg-blue-900/30">üìÇ Open</button>
            </div>
        </header>

        <input type="file" ref="fileInput" class="hidden" accept=".ies,.ldt" @change="handleFileSelect">

        <main class="flex-1 p-3 overflow-y-auto bg-[#141517]">
            
            <div v-if="!parsedData" class="h-full flex flex-col items-center justify-center animate-fade-in">
                <div class="drag-area p-12 rounded-xl text-center cursor-pointer max-w-lg w-full"
                     @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
                    <div class="text-5xl mb-4 opacity-50">üí°</div>
                    <h2 class="text-xl font-bold text-white mb-2">Drop IES / LDT File</h2>
                    <p class="text-gray-500 text-xs">Analyze ‚Ä¢ Edit ‚Ä¢ Visualize ‚Ä¢ Report</p>
                </div>
            </div>

            <div v-else-if="currentView === 'overview'" class="grid grid-cols-12 gap-3 max-w-[1920px] mx-auto pb-10">
                
                <div class="col-span-12 md:col-span-3 dashboard-card h-[320px]">
                    <div class="card-header">Details</div>
                    <div class="card-body p-4 flex flex-col gap-4">
                        <div class="relative">
                            <div class="text-3xl font-bold text-[#ffeb3b]">{{ formatNum(calculated.totalFlux, 0) }}</div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Total Output (lm)</div>
                            <div class="absolute top-0 right-0 text-right">
                                <div class="text-lg font-bold text-white">{{ formatNum(parsedData.watts, 1) }} W</div>
                                <div class="text-[10px] text-gray-500 uppercase">Power</div>
                            </div>
                        </div>

                        <div class="h-px bg-gray-700 w-full"></div>

                        <div class="grid grid-cols-2 gap-y-4 gap-x-2">
                            <div>
                                <div class="text-lg font-bold text-white">{{ formatNum(calculated.maxCandela, 0) }}</div>
                                <div class="text-[10px] text-gray-500 uppercase">Peak (cd)</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-[#4dabf7]">{{ formatNum(calculated.efficacy, 1) }}</div>
                                <div class="text-[10px] text-gray-500 uppercase">Eff. (lm/W)</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-white">{{ calculated.beamAngle }}¬∞</div>
                                <div class="text-[10px] text-gray-500 uppercase">Beam Angle</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-white">{{ checkSymmetry() }}</div>
                                <div class="text-[10px] text-gray-500 uppercase">Symmetry</div>
                            </div>
                        </div>
                        
                        <div class="mt-auto pt-2 text-[10px] text-gray-600 border-t border-gray-800">
                            {{ parsedData.manufacturer }}<br>{{ parsedData.luminaireName }}
                        </div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-5 dashboard-card h-[320px]">
                    <div class="card-header">Polar Plot</div>
                    <div class="card-body">
                        <div id="polarPlot" class="w-full h-full"></div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-4 dashboard-card h-[320px]">
                    <div class="card-header">Linear Plot</div>
                    <div class="card-body">
                        <div id="linearPlot" class="w-full h-full"></div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-4 dashboard-card h-[320px]">
                    <div class="card-header">Iso-candela Plot</div>
                    <div class="card-body">
                        <div id="isoCandelaPlot" class="w-full h-full"></div>
                        <div v-if="!hasIsoData" class="absolute inset-0 flex items-center justify-center bg-black/50 text-gray-400 text-xs">
                            Not enough data points for contour
                        </div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-4 dashboard-card h-[320px]">
                    <div class="card-header">
                        <span>Iso-illuminance Plot</span>
                        <span class="text-[10px] bg-gray-700 px-1 rounded text-white">Height: 3m</span>
                    </div>
                    <div class="card-body">
                        <div id="isoLuxPlot" class="w-full h-full"></div>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-4 dashboard-card h-[320px]">
                    <div class="card-header">Beam Intensities</div>
                    <div class="card-body flex items-center justify-center bg-[#18191c]">
                        <svg viewBox="0 0 400 250" class="w-full h-full" style="max-height: 280px;">
                            <defs>
                                <linearGradient id="beamGrad" x1="0" y1="0" x2="1" y2="0">
                                    <stop offset="0%" stop-color="#ffeb3b" stop-opacity="0.4"/>
                                    <stop offset="100%" stop-color="#ffeb3b" stop-opacity="0.0"/>
                                </linearGradient>
                            </defs>
                            <rect x="10" y="115" width="20" height="20" fill="#333" rx="2" />
                            <path d="M30 125 L380 20 L380 230 Z" fill="url(#beamGrad)" />
                            <line x1="30" y1="125" x2="380" y2="125" stroke="#444" stroke-dasharray="3" />
                            
                            <g v-for="d in [1, 2, 3]" :key="d">
                                <line :x1="30 + d*110" y1="20" :x2="30 + d*110" y2="230" stroke="#333" stroke-width="1"/>
                                <text :x="30 + d*110" y="80" text-anchor="middle" fill="#fff" font-weight="bold" font-size="14">{{ calcLux(d) }} lx</text>
                                <text :x="30 + d*110" y="140" text-anchor="middle" fill="#666" font-size="10">{{ d }}m</text>
                                <text :x="30 + d*110" y="180" text-anchor="middle" fill="#aaa" font-size="10">√ò {{ calcDiam(d) }}m</text>
                            </g>
                        </svg>
                    </div>
                </div>

                <div class="col-span-12 dashboard-card h-[300px]">
                    <div class="card-header">Intensities (cd)</div>
                    <div class="card-body p-0 overflow-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left w-16 bg-[#25262b] sticky left-0 z-20 border-r border-gray-700">V \ H</th>
                                    <th v-for="h in matrixData.hAngles" :key="h">{{ h }}¬∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, i) in matrixData.rows" :key="i">
                                    <td class="bg-[#25262b] sticky left-0 z-10 text-yellow-500 font-bold border-r border-gray-700">{{ matrixData.vAngles[i] }}¬∞</td>
                                    <td v-for="(val, j) in row" :key="j" :style="{color: getCellColor(val)}">{{ val.toFixed(0) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div v-else-if="currentView === 'editor'" class="max-w-4xl mx-auto mt-6">
                <div class="dashboard-card p-6">
                    <h2 class="text-xl font-bold text-white mb-6 pb-2 border-b border-gray-700">Edit & Symmetrize</h2>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold text-blue-400">Basic Info</h3>
                            <div><label class="text-gray-500 text-xs block mb-1">Manufacturer</label><input v-model="parsedData.manufacturer" class="w-full bg-[#141517] border border-[#2c2e33] text-white p-2 rounded text-sm"></div>
                            <div><label class="text-gray-500 text-xs block mb-1">Name</label><input v-model="parsedData.luminaireName" class="w-full bg-[#141517] border border-[#2c2e33] text-white p-2 rounded text-sm"></div>
                            <div><label class="text-gray-500 text-xs block mb-1">Catalog No.</label><input v-model="parsedData.catalogNumber" class="w-full bg-[#141517] border border-[#2c2e33] text-white p-2 rounded text-sm"></div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm font-bold text-yellow-500">Photometrics</h3>
                            <div><label class="text-gray-500 text-xs block mb-1">Power (Watts)</label><input type="number" v-model.number="parsedData.watts" class="w-full bg-[#141517] border border-[#2c2e33] text-white p-2 rounded text-sm"></div>
                            
                            <div v-if="fileType === 'ies'" class="p-3 bg-yellow-900/10 rounded border border-yellow-800/30">
                                <label class="text-yellow-500 text-xs block mb-1 font-bold">Multiplier</label>
                                <div class="flex gap-2">
                                    <input type="number" step="0.01" v-model.number="parsedData.multiplier" class="w-full bg-[#141517] border border-yellow-800/50 text-white p-2 rounded text-sm">
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1">Updates total flux automatically</div>
                            </div>

                            <div v-if="fileType === 'ldt'" class="p-3 bg-yellow-900/10 rounded border border-yellow-800/30">
                                <label class="text-yellow-500 text-xs block mb-1 font-bold">Total Flux (lm)</label>
                                <input type="number" v-model.number="parsedData.totalFlux" class="w-full bg-[#141517] border border-yellow-800/50 text-white p-2 rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-green-400 mb-3">Tools: Symmetrization</h3>
                        <p class="text-xs text-gray-500 mb-3">Convert asymmetric data to symmetric distribution by averaging C-planes.</p>
                        <div class="flex gap-3">
                            <button @click="symmetrize('C0-180')" class="btn btn-outline hover:bg-green-900/30 hover:text-green-400 hover:border-green-500">Make C0-180 Symmetric</button>
                            <button @click="symmetrize('Circular')" class="btn btn-outline hover:bg-green-900/30 hover:text-green-400 hover:border-green-500">Make Circular (Average All)</button>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end gap-3">
                        <button @click="currentView = 'overview'" class="btn text-gray-400 hover:text-white">Cancel</button>
                        <button @click="downloadFile" class="btn btn-primary px-6">Save & Download</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="print-section">
        <div class="report-page">
            <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between;">
                <h1 style="margin:0;">PHOTOMETRIC REPORT</h1>
                <div style="text-align:right;">
                    <b>{{ parsedData?.manufacturer }}</b><br>
                    {{ new Date().toLocaleDateString() }}
                </div>
            </div>
            
            <div class="print-grid">
                <div style="border:1px solid #ccc; padding:10px;">
                    <h3>Luminaire</h3>
                    <p><b>Name:</b> {{ parsedData?.luminaireName }}</p>
                    <p><b>Catalog:</b> {{ parsedData?.catalogNumber }}</p>
                    <p><b>Power:</b> {{ parsedData?.watts }} W</p>
                </div>
                <div style="border:1px solid #ccc; padding:10px;">
                    <h3>Photometry</h3>
                    <p><b>Flux:</b> {{ formatNum(calculated.totalFlux, 0) }} lm</p>
                    <p><b>Efficacy:</b> {{ formatNum(calculated.efficacy, 1) }} lm/W</p>
                    <p><b>Beam Angle:</b> {{ calculated.beamAngle }}¬∞</p>
                </div>
            </div>

            <div class="print-grid">
                <div><div id="printPolar" style="height:350px;"></div></div>
                <div><div id="printLinear" style="height:350px;"></div></div>
            </div>

            <div style="margin-top:20px; border:1px solid #ccc; padding:10px;">
                <h3>Cone Diagram</h3>
                <table style="width:100%; text-align:center;">
                    <tr><th>Distance</th><th>1.0m</th><th>2.0m</th><th>3.0m</th></tr>
                    <tr><td>Illuminance</td><td>{{ calcLux(1) }} lx</td><td>{{ calcLux(2) }} lx</td><td>{{ calcLux(3) }} lx</td></tr>
                    <tr><td>Diameter</td><td>{{ calcDiam(1) }} m</td><td>{{ calcDiam(2) }} m</td><td>{{ calcDiam(3) }} m</td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                currentView: 'overview', fileName: '', fileType: '', rawLines: [], parsedData: null,
                chartData: { vAngles: [], c0Values: [], c90Values: [] },
                matrixData: { vAngles: [], hAngles: [], rows: [] },
                calculated: { totalFlux: 0, efficacy: 0, maxCandela: 0, beamAngle: 0 },
                hasIsoData: false
            }
        },
        watch: {
            'parsedData.multiplier'() { this.reCalculate(); },
            'parsedData.totalFlux'() { this.reCalculate(); },
            'parsedData.watts'() { this.reCalculate(); },
            currentView(val) { if(val === 'overview') nextTick(() => this.drawCharts('screen')); }
        },
        methods: {
            formatNum(v, d) { return typeof v === 'number' ? v.toFixed(d) : '-'; },
            handleFileSelect(e) { this.processFile(e.target.files[0]); },
            handleDrop(e) { this.processFile(e.dataTransfer.files[0]); },
            
            processFile(file) {
                if(!file) return;
                this.fileName = file.name; this.fileType = file.name.toLowerCase().endsWith('ies') ? 'ies' : 'ldt';
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result; this.rawLines = content.split(/\r?\n/);
                    let success = false;
                    try { success = this.fileType === 'ies' ? this.parseIES(content) : this.parseLDT(content); } catch(err) { alert("Error: " + err.message); }
                    if(success) { this.reCalculate(); this.currentView = 'overview'; nextTick(() => this.drawCharts('screen')); }
                };
                reader.readAsText(file, this.fileType === 'ldt' ? 'ISO-8859-1' : 'UTF-8');
            },

            // --- Parser ---
            getTokens(text) { return text.trim().split(/\s+/).map(t => t.trim()).filter(t => t.length > 0); },
            
            parseIES(content) {
                let d = { manufacturer: '', luminaireName: '', catalogNumber: '', watts: 0, multiplier: 1.0 };
                this.rawLines.forEach(l => { if (l.includes('[MANUFAC]')) d.manufacturer = l.split(']')[1].trim(); if (l.includes('[LUMINAIRE]')) d.luminaireName = l.split(']')[1].trim(); if (l.includes('[LUMCAT]')) d.catalogNumber = l.split(']')[1].trim(); });
                const tiltIdx = this.rawLines.findIndex(l => l.trim().startsWith('TILT='));
                if (tiltIdx === -1) throw new Error("No TILT found");
                let tokens = this.getTokens(this.rawLines.slice(tiltIdx).join(" "));
                let p = tokens[0].includes("INCLUDE") ? 2 : 1; 
                const numLamps = parseInt(tokens[p++]); const lumens = parseFloat(tokens[p++]); 
                d.multiplier = parseFloat(tokens[p++]);
                const numV = parseInt(tokens[p++]); const numH = parseInt(tokens[p++]);
                p += 7; d.watts = parseFloat(tokens[p++]);
                let vAngles = []; for(let i=0; i<numV; i++) vAngles.push(parseFloat(tokens[p++]));
                let hAngles = []; for(let i=0; i<numH; i++) hAngles.push(parseFloat(tokens[p++]));
                let rows = []; for(let v=0; v<numV; v++) rows.push(new Array(numH));
                let c0 = [], c90 = [];
                let idx0 = hAngles.findIndex(h => Math.abs(h-0)<0.1); let idx90 = hAngles.findIndex(h => Math.abs(h-90)<0.1);
                for(let h=0; h<numH; h++) {
                    for(let v=0; v<numV; v++) {
                        let val = parseFloat(tokens[p++]); rows[v][h] = val;
                        if(h === idx0) c0.push(val); if(h === idx90) c90.push(val);
                    }
                }
                if(c0.length === 0 && rows.length > 0) c0 = rows.map(r => r[0]);
                this.parsedData = d; this.chartData = { vAngles, c0Values: c0, c90Values: c90 }; this.matrixData = { vAngles, hAngles, rows };
                return true;
            },
            
            parseLDT(content) {
                const lines = this.rawLines; if(lines.length < 30) throw new Error("File too short");
                let d = { manufacturer: lines[0].trim(), catalogNumber: lines[1].trim(), luminaireName: lines[2].trim(), watts: parseFloat(lines[26]), totalFlux: parseFloat(lines[28]), multiplier: 1.0 };
                const numV = parseInt(lines[30]); const numH = parseInt(lines[31]); const dC = parseFloat(lines[32]);
                let p = 42; let vAngles = []; for(let i=0; i<numV; i++) vAngles.push(parseFloat(lines[p++]));
                let hAngles = []; for(let i=0; i<numH; i++) hAngles.push(i * dC);
                let tokens = this.getTokens(lines.slice(p).join(" ")); let tp = 0;
                let rows = []; for(let v=0; v<numV; v++) rows.push(new Array(numH));
                let c0 = [], c90 = []; let idx90 = Math.round(90 / dC);
                for(let h=0; h<numH; h++) {
                    for(let v=0; v<numV; v++) {
                        let val = parseFloat(tokens[tp++]); rows[v][h] = val;
                        if(h === 0) c0.push(val); if(h === idx90) c90.push(val);
                    }
                }
                this.parsedData = d; this.chartData = { vAngles, c0Values: c0, c90Values: c90 }; this.matrixData = { vAngles, hAngles, rows };
                return true;
            },

            // --- Logic ---
            reCalculate() {
                if(!this.parsedData) return;
                let mult = this.fileType === 'ies' ? this.parsedData.multiplier : (this.parsedData.totalFlux / 1000.0);
                if(this.fileType === 'ies') this.calculated.totalFlux = 1000 * mult; else this.calculated.totalFlux = this.parsedData.totalFlux;
                let maxRaw = 0; this.matrixData.rows.forEach(r => r.forEach(v => { if(v>maxRaw) maxRaw=v; }));
                this.calculated.maxCandela = maxRaw * mult;
                this.calculated.efficacy = this.parsedData.watts ? (this.calculated.totalFlux / this.parsedData.watts) : 0;
                let c0Real = this.chartData.c0Values.map(v => v * mult);
                let maxVal = Math.max(...c0Real); let halfMax = maxVal / 2;
                let start = 0, end = 0; let foundStart = false;
                for(let i=0; i<c0Real.length; i++) { if(c0Real[i] >= halfMax) { if(!foundStart) { start = this.chartData.vAngles[i]; foundStart = true; } end = this.chartData.vAngles[i]; } }
                if(this.chartData.vAngles[0] === 0) this.calculated.beamAngle = (end * 2).toFixed(1); else this.calculated.beamAngle = (end - start).toFixed(1);
                
                this.hasIsoData = this.matrixData.hAngles.length > 2 && this.matrixData.vAngles.length > 5;
            },
            
            checkSymmetry() {
                const h = this.matrixData.hAngles;
                if (h.length <= 1) return "Symmetric (0)";
                const last = h[h.length - 1];
                if (Math.abs(last - 360) < 1) return "Asymmetric";
                if (Math.abs(last - 180) < 1) return "Bilateral";
                if (Math.abs(last - 90) < 1) return "Quadrilateral";
                return "Custom";
            },

            symmetrize(type) {
                if (!this.matrixData.rows.length) return;
                let rows = this.matrixData.rows;
                let newRows = [];
                // Simple averaging
                for(let v=0; v<rows.length; v++) {
                    let sum = 0;
                    rows[v].forEach(val => sum += val);
                    let avg = sum / rows[v].length;
                    // Apply avg to all
                    newRows.push(new Array(rows[v].length).fill(avg));
                }
                this.matrixData.rows = newRows;
                // Update charts
                this.chartData.c0Values = newRows.map(r => r[0]);
                this.chartData.c90Values = newRows.map(r => r[0]);
                this.reCalculate();
                alert("Symmetrization Applied: " + type);
            },

            calcLux(d) { return (this.calculated.maxCandela / (d*d)).toFixed(0); },
            calcDiam(d) { let angRad = (this.calculated.beamAngle / 2) * (Math.PI / 180); return (2 * d * Math.tan(angRad)).toFixed(2); },
            getCellColor(val) { 
                let mult = this.fileType==='ies' ? this.parsedData.multiplier : (this.parsedData.totalFlux/1000); 
                let ratio = (val * mult) / this.calculated.maxCandela; 
                return ratio > 0.9 ? '#ffeb3b' : (ratio > 0.5 ? '#fff' : '#555'); 
            },

            // --- Charts ---
            drawCharts(target) {
                let mult = this.fileType==='ies' ? this.parsedData.multiplier : (this.parsedData.totalFlux/1000);
                const c0 = this.chartData.c0Values.map(v => v * mult); const c90 = this.chartData.c90Values.map(v => v * mult);
                const rFull = [...c0, ...c0.reverse()]; const theta = this.chartData.vAngles; const thetaFull = [...theta, ...theta.map(t => -t).reverse()];
                const isScreen = target === 'screen';
                
                // Common layout
                const layoutBase = {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: isScreen?'#9ca3af':'black', size: 10 },
                    margin: { t: 30, b: 30, l: 30, r: 30 },
                    showlegend: false
                };

                // 1. Polar
                Plotly.newPlot(isScreen?'polarPlot':'printPolar', [{ type: 'scatterpolar', mode: 'lines', r: rFull, theta: thetaFull, line: {color: isScreen?'#ffeb3b':'red', width: 2} }, ...(c90.length ? [{ type: 'scatterpolar', mode: 'lines', r: [...c90, ...c90.reverse()], theta: thetaFull, line: {color: isScreen?'#4dabf7':'blue', width: 2, dash: 'dash'} }] : [])], 
                { ...layoutBase, polar: { bgcolor: isScreen?'#1f2023':'white', angularaxis: { rotation: 270, direction: "clockwise", gridcolor: isScreen?'#333':'#eee' }, radialaxis: { gridcolor: isScreen?'#333':'#eee' } } }, {staticPlot: !isScreen, displayModeBar: false});

                // 2. Linear
                Plotly.newPlot(isScreen?'linearPlot':'printLinear', [{ x: theta, y: c0, type: 'scatter', line: {color: isScreen?'#ffeb3b':'red'} }, ...(c90.length ? [{ x: theta, y: c90, type: 'scatter', line: {color: isScreen?'#4dabf7':'blue', dash: 'dash'} }] : [])], 
                { ...layoutBase, xaxis: { gridcolor: isScreen?'#333':'#eee', title: 'Gamma' }, yaxis: { gridcolor: isScreen?'#333':'#eee' } }, {staticPlot: !isScreen, displayModeBar: false});

                // 3. Iso-candela (Heatmap/Contour) - ‰ªÖÂú®Â±èÂπïÊ®°Âºè‰∏îÊúâË∂≥Â§üÊï∞ÊçÆÊó∂
                if (isScreen && this.hasIsoData) {
                    // Prepare matrix Z
                    // X = H Angles, Y = V Angles
                    let z = this.matrixData.rows.map(row => row.map(v => v * mult));
                    Plotly.newPlot('isoCandelaPlot', [{
                        z: z, x: this.matrixData.hAngles, y: this.matrixData.vAngles, type: 'contour',
                        colorscale: 'Viridis', contours: { coloring: 'heatmap' }, line: { width: 0.5, color: 'rgba(255,255,255,0.2)' }
                    }], { ...layoutBase, margin: {t:10,b:30,l:30,r:10}, xaxis: {title:'C-Plane'}, yaxis: {title:'Gamma', autorange: 'reversed'} }, {displayModeBar: false});
                }

                // 4. Iso-illuminance (Lux at 3m) - Ê®°Êãü
                // ÁÆÄÂåñËÆ°ÁÆóÔºöÂÅáËÆæ I(gamma, C) ÊäïÂ∞ÑÂà∞Âπ≥Èù¢
                if (isScreen) {
                    let height = 3;
                    // ÁîüÊàê XY ÁΩëÊ†º
                    let gridSize = 20;
                    let range = 5; // meters
                    let x = [], y = [], zLux = [];
                    for(let i=-gridSize; i<=gridSize; i++) {
                        let row = [];
                        let py = i * (range/gridSize);
                        y.push(py);
                        for(let j=-gridSize; j<=gridSize; j++) {
                            let px = j * (range/gridSize);
                            if(i===0) x.push(px);
                            // Calc Gamma/C for point (px, py)
                            let d = Math.sqrt(px*px + py*py);
                            let gamma = Math.atan(d/height) * (180/Math.PI);
                            let C = Math.atan2(py, px) * (180/Math.PI);
                            if(C<0) C+=360;
                            
                            // Get Intensity (Interpolation simplified: pick nearest)
                            // ÂÆûÈôÖÈúÄË¶ÅÂèåÁ∫øÊÄßÊèíÂÄºÔºåËøôÈáåÂèñ C0 ÁöÑ gamma ÊèíÂÄºÁÆÄÂåñÊºîÁ§∫
                            let gIdx = Math.round(gamma / (this.matrixData.vAngles[1] || 1));
                            if(gIdx >= this.matrixData.rows.length) gIdx = this.matrixData.rows.length - 1;
                            let I = (this.matrixData.rows[gIdx] ? this.matrixData.rows[gIdx][0] : 0) * mult;
                            
                            // Lux = (I * cos(gamma)) / dist^2 = I * cos^3(gamma) / h^2
                            let cosG = Math.cos(gamma * Math.PI/180);
                            let lux = (I * Math.pow(cosG, 3)) / (height*height);
                            row.push(lux);
                        }
                        zLux.push(row);
                    }
                    
                    Plotly.newPlot('isoLuxPlot', [{
                        z: zLux, x: x, y: y, type: 'contour',
                        colorscale: 'Jet', contours: { showlabels: true }
                    }], { ...layoutBase, xaxis: {title:'Meters'}, yaxis: {title:'Meters'} }, {displayModeBar: false});
                }
            },

            printReport() { this.drawCharts('print'); setTimeout(() => window.print(), 500); },
            downloadFile() {
                let content = ""; const d = this.parsedData;
                if (this.fileType === 'ies') { let lines = [...this.rawLines]; const setHeader = (k, v) => { let idx = lines.findIndex(l => l.includes(`[${k}]`)); if(idx > -1) lines[idx] = `[${k}] ${v}`; else if(v) lines.splice(1, 0, `[${k}] ${v}`); }; setHeader('MANUFAC', d.manufacturer); setHeader('LUMINAIRE', d.luminaireName); setHeader('LUMCAT', d.catalogNumber); content = lines.join("\n"); } 
                else { let lines = [...this.rawLines]; lines[0] = d.manufacturer; lines[1] = d.catalogNumber; lines[2] = d.luminaireName; lines[26] = d.watts.toString(); lines[28] = d.totalFlux.toString(); content = lines.join("\r\n"); }
                const blob = new Blob([content], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "mod_" + this.fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }
    }).mount('#app');
</script>
</body>
</html>
