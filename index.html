<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES & LDT é…å…‰æ–‡ä»¶ç¼–è¾‘å™¨ Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .drag-area { border: 2px dashed #cbd5e1; transition: all 0.3s; }
        .drag-area:hover, .drag-area.active { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body>

<div id="app" class="max-w-3xl mx-auto p-6">
    
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">ğŸ’¡ IES & LDT ç¼–è¾‘å™¨</h1>
        <p class="text-gray-500 mt-2">æ”¯æŒä¿®æ”¹å‚å®¶ã€åŠŸç‡ã€è‰²æ¸©ã€æ˜¾æŒ‡åŠå…‰é€šé‡</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div 
            class="drag-area rounded-lg p-10 text-center cursor-pointer"
            @click="$refs.fileInput.click()"
            @dragover.prevent
            @drop.prevent="handleDrop"
        >
            <input type="file" ref="fileInput" class="hidden" accept=".ies,.ldt" @change="handleFileSelect">
            <div v-if="!fileName">
                <p class="text-4xl mb-2">ğŸ“‚</p>
                <p class="text-gray-600 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  IES / LDT æ–‡ä»¶</p>
            </div>
            <div v-else>
                <p class="text-4xl mb-2">ğŸ“„</p>
                <p class="text-green-600 font-bold text-lg">{{ fileName }}</p>
                <p class="text-xs text-gray-400 mt-1 uppercase">{{ fileType }} æ ¼å¼</p>
            </div>
        </div>
    </div>

    <div v-if="parsedData" class="bg-white rounded-xl shadow-md p-6 animate-fade-in">
        <div class="flex justify-between items-center border-b pb-4 mb-4">
            <h2 class="text-xl font-bold text-gray-700">å‚æ•°ä¿®æ”¹</h2>
            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">
                {{ fileType === 'ies' ? 'IES æ ‡å‡†' : 'EULUMDAT (LDT) æ ‡å‡†' }}
            </span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å‚å®¶ (Manufacturer)</label>
                <input v-model="parsedData.manufacturer" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ç¯å…·åç§° (Luminaire Name)</label>
                <input v-model="parsedData.luminaireName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ç³»ç»ŸåŠŸç‡ (Watts)</label>
                <input type="number" v-model="parsedData.watts" step="0.1" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            
            <div v-if="fileType === 'ies'">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    å…‰é€šé‡å€å¢å› å­ 
                    <span class="text-xs text-gray-400" title="ä¿®æ”¹æ­¤æ•°å€¼ä¼šç­‰æ¯”ç¼©æ”¾æ•´ä¸ªé…å…‰æ›²çº¿">(Multiplier) â„¹ï¸</span>
                </label>
                <input type="number" v-model="parsedData.multiplier" step="0.001" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50">
            </div>
            <div v-if="fileType === 'ldt'">
                <label class="block text-sm font-medium text-gray-700 mb-1">æ€»å…‰é€šé‡ (Total Flux)</label>
                <input type="number" v-model="parsedData.totalFlux" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none bg-yellow-50">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">äº§å“å‹å· (Catalog/Type)</label>
                <input v-model="parsedData.catalogNumber" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
        </div>

        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-sm font-bold text-gray-600 mb-2">æ‰©å±•ä¿¡æ¯ (è‰²æ¸©/æ˜¾æŒ‡ç­‰)</h3>
            <p v-if="fileType === 'ldt'" class="text-xs text-orange-500 mb-2">âš ï¸ LDT æ ‡å‡†ä¸æ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾ï¼Œè¿™äº›ä¿¡æ¯å°†è¿½åŠ åˆ°â€œç¯å…·æè¿°â€å­—æ®µä¸­ã€‚</p>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500">è‰²æ¸© (CCT)</label>
                    <input v-model="parsedData.cct" placeholder="ä¾‹å¦‚: 3000K" class="w-full p-2 border rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500">æ˜¾è‰²æŒ‡æ•° (CRI)</label>
                    <input v-model="parsedData.cri" placeholder="ä¾‹å¦‚: Ra90" class="w-full p-2 border rounded text-sm">
                </div>
            </div>
        </div>

        <button 
            @click="downloadFile" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex justify-center items-center gap-2"
        >
            <span>â¬‡ï¸ ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶</span>
        </button>
    </div>

</div>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                fileContent: null, // åŸå§‹æ–‡ä»¶å†…å®¹å­—ç¬¦ä¸²
                rawLines: [],      // æŒ‰è¡Œåˆ†å‰²
                fileName: '',
                fileType: '',      // 'ies' or 'ldt'
                
                // ç»Ÿä¸€çš„æ•°æ®æ¨¡å‹
                parsedData: null 
                // ç»“æ„: { manufacturer, luminaireName, catalogNumber, watts, multiplier(ies), totalFlux(ldt), cct, cri }
            }
        },
        methods: {
            handleFileSelect(event) {
                const file = event.target.files[0]
                if (file) this.processFile(file)
            },
            handleDrop(event) {
                const file = event.dataTransfer.files[0]
                if (file) this.processFile(file)
            },
            processFile(file) {
                this.fileName = file.name
                const ext = file.name.split('.').pop().toLowerCase()
                
                const reader = new FileReader()
                reader.onload = (e) => {
                    this.fileContent = e.target.result
                    this.rawLines = this.fileContent.split(/\r?\n/)
                    
                    if (ext === 'ies') {
                        this.fileType = 'ies'
                        this.parseIES()
                    } else if (ext === 'ldt') {
                        this.fileType = 'ldt'
                        this.parseLDT()
                    } else {
                        alert("ä»…æ”¯æŒ .ies å’Œ .ldt æ–‡ä»¶")
                        this.parsedData = null
                    }
                }
                reader.readAsText(file, 'ISO-8859-1') // LDTé€šå¸¸ä½¿ç”¨è¿™ç§ç¼–ç ï¼ŒIESä¸€èˆ¬æ˜¯UTF-8æˆ–ASCIIï¼Œè¿™é‡Œå…¼å®¹å¤„ç†
            },

            // --- IES è§£æé€»è¾‘ ---
            parseIES() {
                const lines = this.rawLines
                let data = {
                    manufacturer: '', luminaireName: '', catalogNumber: '', 
                    watts: 0, multiplier: 1.0, cct: '', cri: ''
                }

                // 1. æå– Header æ ‡ç­¾
                lines.forEach(line => {
                    if (line.startsWith('[')) {
                        if (line.includes('MANUFAC')) data.manufacturer = this.getIESValue(line)
                        if (line.includes('LUMCAT')) data.catalogNumber = this.getIESValue(line)
                        if (line.includes('LUMINAIRE')) data.luminaireName = this.getIESValue(line)
                        // è‡ªå®šä¹‰/éæ ‡å‡†æ ‡ç­¾è¯»å–
                        if (line.includes('CCT') || line.includes('COLORTEMP')) data.cct = this.getIESValue(line)
                        if (line.includes('CRI') || line.includes('RA')) data.cri = this.getIESValue(line)
                    }
                })

                // 2. æå– TILT åçš„å‚æ•° (Multiplier & Watts)
                // æŸ¥æ‰¾ TILT è¡Œ
                let tiltIndex = lines.findIndex(l => l.trim().startsWith('TILT='))
                if (tiltIndex !== -1) {
                    // IESæ•°æ®æµé€šå¸¸åœ¨ TILT åçš„ç¬¬ä¸€è¡Œæˆ–æ‹¼åˆåçš„æ•°æ®æµä¸­
                    // ç®€åŒ–å¤„ç†ï¼šå‡è®¾æ•°æ®ç´§è·Ÿå…¶åã€‚æˆ‘ä»¬éœ€è¦åˆå¹¶ TILT åçš„å‡ è¡Œæ¥è§£æ
                    // çœŸå®çš„ IES è§£ææ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œåšç®€åŒ–å‡è®¾ï¼š
                    // TILT=NONE ä¸‹ä¸€è¡Œé€šå¸¸æ˜¯: #Lamps Lumens Multiplier V-Ang H-Ang Type Units Width Len Height
                    // å†å¾€åæŸå¤„æ˜¯ Ballast Factor å’Œ Input Watts
                    
                    // ä¸ºäº†æ‰¾åˆ° Wattage (é€šå¸¸åœ¨æ•°æ®åŒºçš„æœ€åéƒ¨åˆ†)ï¼ŒIESè§£æå¤ªå¤æ‚ï¼Œ
                    // è¿™é‡Œæˆ‘ä»¬å°è¯•æ‰¾åŒ…å« Multiplier çš„é‚£ä¸€è¡Œã€‚
                    
                    // æš‚æ—¶åªæ”¯æŒç²¾å‡†ä¿®æ”¹ Multiplierï¼ŒWattage åœ¨ IES ä¸­é€šå¸¸æ˜¯ Ballast Watts
                    // ä½äºæ•°æ®æµçš„ "Input Watts" ä½ç½®
                    
                    // ç®€æ˜“æŠ“å– Multiplier (å‡è®¾åœ¨ TILT åå‡ è¡Œå†…)
                    let dataStream = lines.slice(tiltIndex + 1, tiltIndex + 20).join(" ").trim().split(/\s+/)
                    if (dataStream.length > 5) {
                        data.multiplier = parseFloat(dataStream[2]) // ç¬¬3ä¸ªå‚æ•°
                        // Wattage åœ¨ IES é‡Œçš„ä½ç½®éå¸¸é åï¼Œè§£æå›°éš¾ï¼Œæš‚è®¾ä¸ºé»˜è®¤æˆ–è®©ç”¨æˆ·å¡«
                        // å°è¯•è¯»å–: æœ€åä¸€ä¸ªéæ•°æ®çŸ©é˜µçš„å‚æ•°é€šå¸¸æ˜¯ Input Watts
                        // è¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œå¦‚æœè¯»ä¸åˆ°å°±ä¸å¡«
                    }
                }
                this.parsedData = data
            },
            getIESValue(line) {
                return line.substring(line.indexOf(']') + 1).trim()
            },

            // --- LDT è§£æé€»è¾‘ ---
            parseLDT() {
                const lines = this.rawLines
                if (lines.length < 30) { alert("LDT æ–‡ä»¶ä¼¼ä¹å·²æŸå"); return; }
                
                // LDT æ˜¯æŒ‰è¡Œå·æ¥çš„ (EULUMDAT æ ‡å‡†)
                // Line 0 (Index 0): Manufacturer
                // Line 1: Type (Catalog Number) -> æœ‰æ—¶ä¹Ÿæ˜¯ Name
                // Line 2: Luminaire Name
                // ...
                // Line 26: Wattage
                // Line 28: Total Luminous Flux
                
                this.parsedData = {
                    manufacturer: lines[0].trim(),
                    catalogNumber: lines[1].trim(), // Type
                    luminaireName: lines[2].trim(), // Name
                    watts: parseFloat(lines[26]),
                    totalFlux: parseInt(lines[28]),
                    cct: '', // LDT æ— æ ‡å‡†ä½
                    cri: '', // LDT æ— æ ‡å‡†ä½
                    multiplier: 1.0 // LDT ä¸ç”¨è¿™ä¸ªï¼Œä½†ä¸ºäº†ç»Ÿä¸€æ¨¡å‹
                }
            },

            // --- ä¸‹è½½ä¸ç”Ÿæˆ ---
            downloadFile() {
                let content = ""
                if (this.fileType === 'ies') {
                    content = this.generateIES()
                } else {
                    content = this.generateLDT()
                }

                const blob = new Blob([content], { type: 'text/plain' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                // åœ¨åŸæ–‡ä»¶åå‰åŠ  mod_
                a.download = 'mod_' + this.fileName
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
            },

            generateIES() {
                let newLines = [...this.rawLines]
                const d = this.parsedData
                
                // 1. æ›´æ–°æˆ–æ·»åŠ  Header æ ‡ç­¾
                this.updateIESLine(newLines, 'MANUFAC', d.manufacturer)
                this.updateIESLine(newLines, 'LUMINAIRE', d.luminaireName)
                this.updateIESLine(newLines, 'LUMCAT', d.catalogNumber)
                
                // å†™å…¥è‡ªå®šä¹‰æ ‡ç­¾ CCT / CRI
                if (d.cct) this.updateIESLine(newLines, 'CCT', d.cct, true)
                if (d.cri) this.updateIESLine(newLines, 'CRI', d.cri, true)

                // 2. æ›´æ–° Multiplier
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–æ›¿æ¢ï¼Œå®šä½åˆ° TILT åï¼Œæ‰¾åˆ°åŸæ¥çš„ Multiplier æ•°å­—å¹¶æ›¿æ¢
                // é£é™©ï¼šå¦‚æœåŸæ¥çš„æ•°å­—æ˜¯ 1ï¼Œå¯èƒ½ä¼šè¯¯æ¢æˆç¯æ³¡æ•°é‡ã€‚
                // ç¨³å¦¥æ–¹æ¡ˆï¼šé‡æ–°æ„å»º TILT åçš„ç¬¬ä¸€è¡Œæ•°æ®å­—ç¬¦ä¸²
                
                let tiltIndex = newLines.findIndex(l => l.trim().startsWith('TILT='))
                if (tiltIndex !== -1) {
                     // è¯»å–TILTåçš„ä¸€è¡Œ (å‡è®¾æœªæ¢è¡Œ)
                     // å®é™…æƒ…å†µå»ºè®®æ›´å¤æ‚çš„ Token å¤„ç†ï¼Œè¿™é‡Œåšç®€å•æ­£åˆ™æ›¿æ¢
                     // æ›¿æ¢é€»è¾‘ï¼šæ‰¾åˆ°è¡Œå†…ç¬¬3ä¸ªæ•°å­—
                     let targetLineIdx = tiltIndex + 1
                     // å¦‚æœæ˜¯ TILT=INCLUDEï¼Œè¦è·³è¿‡æ–‡ä»¶åï¼Œè¿™é‡Œå‡è®¾ TILT=NONE
                     
                     let tokens = newLines[targetLineIdx].trim().split(/\s+/)
                     if (tokens.length >= 3) {
                         tokens[2] = d.multiplier // ä¿®æ”¹å€æ•°
                         // é‡ç»„è¯¥è¡Œ
                         newLines[targetLineIdx] = tokens.join(" ")
                     }
                }
                
                return newLines.join('\n')
            },

            updateIESLine(lines, key, value, forceAdd = false) {
                const tag = `[${key}]`
                const idx = lines.findIndex(l => l.startsWith(tag))
                if (idx !== -1) {
                    lines[idx] = `${tag} ${value}`
                } else if (forceAdd && value) {
                    // å¦‚æœæ²¡æ‰¾åˆ°ä¸”éœ€è¦å¼ºåˆ¶æ·»åŠ ï¼ŒåŠ åœ¨ç¬¬ä¸€è¡Œåé¢
                    lines.splice(1, 0, `${tag} ${value}`)
                }
            },

            generateLDT() {
                let newLines = [...this.rawLines]
                const d = this.parsedData

                // LDT ç›´æ¥æ›¿æ¢è¡Œ
                newLines[0] = d.manufacturer
                newLines[1] = d.catalogNumber
                newLines[2] = d.luminaireName
                
                // å¤„ç† CCT / CRI -> LDT æ²¡æœ‰ä½ç½®æ”¾ï¼Œè¿½åŠ åˆ° Line 2 (Name) åé¢ï¼Œæˆ–è€…ä¸åšå¤„ç†
                // è®¸å¤šè½¯ä»¶ä¼šè¯»å– Name é‡Œçš„ä¿¡æ¯
                if (d.cct || d.cri) {
                    let extra = ` (${d.cct} ${d.cri})`.trim()
                    if (!newLines[2].includes(extra)) {
                        newLines[2] = newLines[2] + extra
                    }
                }

                newLines[26] = d.watts.toString()
                newLines[28] = d.totalFlux.toString()

                return newLines.join('\r\n') // LDT ä¸¥æ ¼è¦æ±‚ CRLF
            }
        }
    }).mount('#app')
</script>

</body>
</html>
