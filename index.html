<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…å…‰æ›²çº¿åˆ†æä¸æŠ¥å‘Šç”Ÿæˆå·¥å…·</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .drag-area { border: 2px dashed #cbd5e1; transition: all 0.3s; }
        .drag-area:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .tab-btn { @apply px-4 py-2 font-bold text-sm rounded-t-lg transition-colors; }
        .tab-btn.active { @apply bg-white text-blue-600 border-t-2 border-x border-blue-600 border-b-transparent; }
        .tab-btn.inactive { @apply bg-gray-200 text-gray-500 hover:bg-gray-300; }
        
        /* A4 æŠ¥å‘Šæ ·å¼ */
        .report-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            color: #000;
        }
        
        /* æ‰“å°æ§åˆ¶ï¼šæ‰“å°æ—¶éšè—éæŠ¥å‘ŠåŒºåŸŸ */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .report-page { 
                box-shadow: none; 
                margin: 0; 
                width: 100%;
                page-break-after: always;
            }
            /* å¼ºåˆ¶èƒŒæ™¯è‰²æ‰“å° (ç”¨äºè¡¨å¤´) */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div id="app">
    
    <div class="max-w-6xl mx-auto p-4 no-print">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center mb-6">ğŸ’¡ é…å…‰åˆ†æ & æŠ¥å‘Šç”Ÿæˆå™¨</h1>
        
        <div v-if="!parsedData" class="bg-white rounded-xl shadow p-8 mb-6 drag-area cursor-pointer text-center"
             @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
            <input type="file" ref="fileInput" class="hidden" accept=".ies,.ldt" @change="handleFileSelect">
            <p class="text-4xl mb-2">ğŸ“‚</p>
            <p class="text-gray-600">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  IES / LDT æ–‡ä»¶</p>
        </div>

        <div v-else class="bg-white rounded-xl shadow overflow-hidden">
            <div class="flex justify-between items-center bg-gray-50 px-6 py-4 border-b">
                <div>
                    <h2 class="font-bold text-lg text-gray-800">{{ fileName }}</h2>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">{{ fileType }}</span>
                </div>
                <div class="flex gap-2">
                    <button @click="reset" class="px-3 py-1 text-sm text-red-500 hover:text-red-700">âŒé‡æ–°ä¸Šä¼ </button>
                    <button @click="printReport" class="px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 font-bold">
                        ğŸ–¨ï¸ æ‰“å° / å¦å­˜ä¸º PDF
                    </button>
                </div>
            </div>

            <div class="flex bg-gray-100 px-4 pt-2 gap-2 border-b">
                <button @click="switchTab('editor')" :class="['tab-btn', currentTab === 'editor' ? 'active' : 'inactive']">ğŸ“ ç¼–è¾‘å‚æ•°</button>
                <button @click="switchTab('report')" :class="['tab-btn', currentTab === 'report' ? 'active' : 'inactive']">ğŸ“„ é¢„è§ˆæŠ¥å‘Š (Report)</button>
            </div>

            <div v-show="currentTab === 'editor'" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å‚å®¶ (Manufacturer)</label>
                        <input v-model="parsedData.manufacturer" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ç¯å…·åç§° (Name)</label>
                        <input v-model="parsedData.luminaireName" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å‹å· (Catalog)</label>
                        <input v-model="parsedData.catalogNumber" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">åŠŸç‡ (Watts)</label>
                        <input type="number" v-model.number="parsedData.watts" class="w-full border p-2 rounded">
                    </div>
                    <div v-if="fileType === 'ies'">
                        <label class="block text-sm font-bold text-gray-700 mb-1">å€å¢å› å­ (Multiplier)</label>
                        <input type="number" v-model.number="parsedData.multiplier" step="0.01" class="w-full border p-2 rounded bg-yellow-50">
                    </div>
                    <div v-if="fileType === 'ldt'">
                        <label class="block text-sm font-bold text-gray-700 mb-1">æ€»å…‰é€šé‡ (lm)</label>
                        <input type="number" v-model.number="parsedData.totalFlux" class="w-full border p-2 rounded bg-yellow-50">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">è‰²æ¸© (CCT)</label>
                        <input v-model="parsedData.cct" placeholder="e.g. 3000K" class="w-full border p-2 rounded">
                    </div>
                </div>
                
                <div class="mt-8 border-t pt-4">
                     <button @click="downloadFile" class="w-full py-3 bg-green-600 text-white rounded font-bold shadow hover:bg-green-700">
                        ğŸ’¾ ä¸‹è½½ä¿®æ”¹åçš„ IES/LDT æ–‡ä»¶
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="parsedData" v-show="currentTab === 'report' || isPrinting" class="pb-10">
        <div class="report-page text-sm">
            
            <div class="border-b-2 border-black pb-4 mb-6 flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">LUMINAIRE PHOTOMETRIC TEST REPORT</h1>
                    <p class="text-gray-500 mt-1">Generated by Web IES Tool</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-lg">{{ parsedData.manufacturer || 'Unknown Brand' }}</p>
                    <p>{{ new Date().toLocaleDateString() }}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 mb-6">
                <table class="w-full border-collapse border border-gray-300">
                    <tr class="bg-gray-100"><th colspan="2" class="border p-2 text-left">Luminaire Data</th></tr>
                    <tr><td class="border p-2 font-bold">Name</td><td class="border p-2">{{ parsedData.luminaireName }}</td></tr>
                    <tr><td class="border p-2 font-bold">Catalog No.</td><td class="border p-2">{{ parsedData.catalogNumber }}</td></tr>
                    <tr><td class="border p-2 font-bold">Watts</td><td class="border p-2">{{ parsedData.watts }} W</td></tr>
                    <tr><td class="border p-2 font-bold">CCT / CRI</td><td class="border p-2">{{ parsedData.cct || 'N/A' }} / {{ parsedData.cri || 'N/A' }}</td></tr>
                </table>

                <table class="w-full border-collapse border border-gray-300">
                    <tr class="bg-gray-100"><th colspan="2" class="border p-2 text-left">Photometric Data</th></tr>
                    <tr><td class="border p-2 font-bold">Total Flux</td><td class="border p-2">{{ calculated.totalFlux.toFixed(0) }} lm</td></tr>
                    <tr><td class="border p-2 font-bold">Efficacy</td><td class="border p-2">{{ calculated.efficacy.toFixed(1) }} lm/W</td></tr>
                    <tr><td class="border p-2 font-bold">Max Candela</td><td class="border p-2">{{ calculated.maxCandela.toFixed(0) }} cd</td></tr>
                    <tr><td class="border p-2 font-bold">Beam Angle (50%)</td><td class="border p-2">{{ calculated.beamAngle }}Â°</td></tr>
                </table>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="border border-gray-200 p-2">
                    <h3 class="font-bold text-center mb-2">Luminous Intensity Distribution</h3>
                    <div id="reportPolar" style="width:100%; height:300px;"></div>
                </div>
                
                <div class="border border-gray-200 p-2">
                    <h3 class="font-bold text-center mb-2">Cartesian Distribution</h3>
                    <div id="reportCartesian" style="width:100%; height:300px;"></div>
                </div>
            </div>

            <div class="border border-gray-300 p-4 mb-6">
                <h3 class="font-bold text-lg mb-4 border-b pb-2">Illuminance at a Distance</h3>
                <div class="flex justify-around items-end h-40 mb-2">
                    <div v-for="d in [1, 2, 3]" :key="d" class="text-center w-1/3 relative">
                        <div class="mx-auto bg-gradient-to-b from-yellow-200 to-transparent opacity-50" 
                             :style="{width: (coneData[d].diameter * 20) + 'px', height: '100px', clipPath: 'polygon(50% 0, 100% 100%, 0 100%)'}"></div>
                        <div class="absolute top-0 w-full text-center font-bold text-gray-800">{{ coneData[d].lux }} lx</div>
                        <div class="border-t-2 border-black mt-1 pt-1">
                            <p class="font-bold">{{ d }} m</p>
                            <p class="text-gray-600 text-xs">Ã¸ {{ coneData[d].diameter }} m</p>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 text-center mt-2">Note: The curve is for the C0 plane. Beam angle defined at 50% Imax.</p>
            </div>

            <div class="text-xs text-gray-400 border-t pt-2 mt-auto">
                Test Report Generated via Online IES Editor. 
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, nextTick } = Vue

    createApp({
        data() {
            return {
                currentTab: 'editor',
                isPrinting: false,
                fileName: '',
                fileType: '',
                rawLines: [],
                parsedData: null, // { watts, multiplier, ... }
                chartData: { vAngles: [], c0Values: [], c90Values: [] },
                
                // è®¡ç®—å±æ€§ç¼“å­˜
                calculated: { totalFlux: 0, efficacy: 0, maxCandela: 0, beamAngle: 0 },
                coneData: { 1: {lux:0, diameter:0}, 2: {lux:0, diameter:0}, 3: {lux:0, diameter:0} }
            }
        },
        watch: {
            'parsedData.multiplier'() { this.reCalculate(); },
            'parsedData.totalFlux'() { this.reCalculate(); },
            'parsedData.watts'() { this.reCalculate(); },
            currentTab(val) {
                if(val === 'report') nextTick(() => this.drawReportCharts());
            }
        },
        methods: {
            switchTab(tab) { this.currentTab = tab; },
            handleFileSelect(e) { this.processFile(e.target.files[0]); },
            handleDrop(e) { this.processFile(e.dataTransfer.files[0]); },
            reset() { this.parsedData = null; this.fileName = ''; },
            
            processFile(file) {
                if(!file) return;
                this.fileName = file.name;
                this.fileType = file.name.toLowerCase().endsWith('ies') ? 'ies' : 'ldt';
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.rawLines = e.target.result.split(/\r?\n/);
                    let success = this.fileType === 'ies' ? this.parseIES(e.target.result) : this.parseLDT();
                    if(success) {
                        this.reCalculate();
                        this.switchTab('report'); // é»˜è®¤è·³åˆ°æŠ¥å‘Šé¡µçœ‹çœ‹æ•ˆæœ
                    }
                };
                reader.readAsText(file);
            },

            // --- æ ¸å¿ƒè®¡ç®—é€»è¾‘ (æ–°å¢) ---
            reCalculate() {
                const pd = this.parsedData;
                const cd = this.chartData;
                
                // 1. ç¡®å®šçœŸå®å…‰å¼ºå€ç‡
                let finalMult = 1.0;
                if(this.fileType === 'ies') {
                    finalMult = pd.multiplier;
                    this.calculated.totalFlux = this.estimateFluxFromIES(); // ç®€å•ä¼°ç®—æˆ–ç”¨å·²æœ‰å€¼
                } else {
                    // LDT å…‰å¼ºé€šå¸¸æ˜¯ cd/klmï¼Œéœ€è¦æ¢ç®—å› cd
                    // LDT çš„ raw values æ˜¯æ¯ 1000lm çš„ cd å€¼
                    // çœŸå® cd = (raw * TotalFlux) / 1000
                    finalMult = pd.totalFlux / 1000.0; 
                    this.calculated.totalFlux = pd.totalFlux;
                }
                
                // 2. æŸ¥æ‰¾æœ€å¤§å…‰å¼º (Max Candela)
                let maxRaw = Math.max(...cd.c0Values, ...(cd.c90Values || []));
                this.calculated.maxCandela = maxRaw * finalMult;
                
                // 3. è®¡ç®—å…‰æ•ˆ
                this.calculated.efficacy = pd.watts > 0 ? (this.calculated.totalFlux / pd.watts) : 0;

                // 4. è®¡ç®—å…‰æŸè§’ (Beam Angle) - å¯»æ‰¾ C0 å¹³é¢ 50% å¼ºåº¦å¤„
                // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç®—æ³•ï¼šä»æœ€å¤§å€¼å‘ä¸¤ä¾§å¯»æ‰¾ä¸‹é™åˆ° 50% çš„ç‚¹
                this.calculated.beamAngle = this.calcBeamAngle(cd.c0Values, cd.vAngles);

                // 5. è®¡ç®—é”¥çŠ¶å›¾æ•°æ® (Inverse Square Law)
                // E = I / d^2
                // D = 2 * d * tan(angle/2)
                const Imax = this.calculated.maxCandela;
                const angleRad = (this.calculated.beamAngle / 2) * (Math.PI / 180);
                const tanVal = Math.tan(angleRad);
                
                [1, 2, 3].forEach(d => {
                    this.coneData[d] = {
                        lux: (Imax / (d * d)).toFixed(0),
                        diameter: (2 * d * tanVal).toFixed(2)
                    };
                });

                nextTick(() => this.drawReportCharts(finalMult));
            },

            calcBeamAngle(values, angles) {
                if(!values || values.length === 0) return 0;
                const max = Math.max(...values);
                const halfMax = max / 2;
                
                // æ‰¾åˆ° max çš„ç´¢å¼•
                const maxIdx = values.indexOf(max);
                
                // å‘å·¦æ‰¾
                let leftAng = angles[0];
                for(let i = maxIdx; i >= 0; i--) {
                    if(values[i] < halfMax) {
                        leftAng = angles[i]; // ç®€å•å–å€¼ï¼Œä¸åšçº¿æ€§æ’å€¼äº†
                        break;
                    }
                }
                // å‘å³æ‰¾
                let rightAng = angles[angles.length - 1];
                for(let i = maxIdx; i < values.length; i++) {
                     if(values[i] < halfMax) {
                        rightAng = angles[i];
                        break;
                    }
                }
                // å¦‚æœæ˜¯ C0-180 å¯¹ç§°ï¼Œå…‰æŸè§’é€šå¸¸ = (right - left) 
                // ä½†å¦‚æœæ˜¯ 0-90 (downlight)ï¼Œå…‰æŸè§’ = 2 * right (å‡è®¾0æ˜¯å¯¹ç§°è½´)
                // è¿™é‡Œåšä¸ªç®€æ˜“åˆ¤æ–­ï¼šå¦‚æœ leftAng æ˜¯ 0ï¼Œè¯´æ˜æ˜¯åŠè¾¹æ•°æ®
                if(leftAng === 0 && angles[0] === 0) return (rightAng * 2).toFixed(1);
                return (rightAng - leftAng).toFixed(1);
            },
            
            estimateFluxFromIES() {
                // IES æ–‡ä»¶å¤´é‡Œé€šå¸¸æœ‰ fluxï¼Œä½†å¦‚æœæ˜¯ä» raw data ç§¯åˆ†å¤ªå¤æ‚
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾ header é‡Œè¯»åˆ°çš„æˆ–è€…ç”¨æˆ·å¡«çš„æ˜¯å¯¹çš„
                // å¦‚æœå¿…é¡»è®¡ç®—ï¼Œéœ€è¦ sum(I * sin(v) * dV * dH)
                return 1000 * this.parsedData.multiplier; // å ä½ï¼Œå®é™…ä¸ŠIESè§£æé‡Œæ²¡å­˜Fluxï¼Œæš‚ç”¨å€æ•°æ¨¡æ‹Ÿ
            },

            // --- ç»˜å›¾ (ä¸“é—¨é’ˆå¯¹æŠ¥å‘Šé¡µ) ---
            drawReportCharts(mult = 1.0) {
                if(this.currentTab !== 'report' && !this.isPrinting) return;
                
                const c0 = this.chartData.c0Values.map(v => v * mult);
                // æåæ ‡é•œåƒ
                const rFull = [...c0, ...c0.reverse()]; // ç®€å•é•œåƒ
                const theta = this.chartData.vAngles;
                const thetaFull = [...theta, ...theta.map(t => -t).reverse()];

                // æåæ ‡é…ç½® (é™æ€ï¼Œå°‘äº¤äº’)
                const polarLayout = {
                    polar: {
                        radialaxis: { visible: true, tickfont: {size: 8} },
                        angularaxis: { direction: "clockwise", rotation: 270, tickfont: {size: 8} }
                    },
                    margin: { t: 20, b: 20, l: 20, r: 20 },
                    showlegend: true,
                    legend: { x: 0.5, y: -0.1, xanchor: 'center', orientation: 'h' }
                };
                Plotly.newPlot('reportPolar', [{
                    type: 'scatterpolar', mode: 'lines', r: rFull, theta: thetaFull, 
                    line: {color: 'red', width: 2}, name: 'C0/180'
                }], polarLayout, {staticPlot: true});

                // ç›´è§’åæ ‡é…ç½®
                Plotly.newPlot('reportCartesian', [{
                    x: theta, y: c0, type: 'scatter', mode: 'lines', line: {color: 'red'}, name: 'C0'
                }], {
                    margin: { t: 10, b: 30, l: 40, r: 10 },
                    xaxis: {title: 'Gamma', range: [0, 180]},
                    yaxis: {title: 'cd'}
                }, {staticPlot: true});
            },

            printReport() {
                this.isPrinting = true;
                this.switchTab('report');
                setTimeout(() => {
                    window.print();
                    this.isPrinting = false;
                }, 500);
            },

            // --- è§£æå™¨ (ç²¾ç®€ç‰ˆï¼Œå¤ç”¨ä¹‹å‰çš„é€»è¾‘) ---
            parseLDT() {
                // ç®€å•å®ç°ï¼Œå¤ç”¨ä¹‹å‰é€»è¾‘ï¼Œæå– totalFlux
                const lines = this.rawLines;
                if(lines.length < 30) return false;
                this.parsedData = {
                    manufacturer: lines[0], catalogNumber: lines[1], luminaireName: lines[2],
                    watts: parseFloat(lines[26]), totalFlux: parseFloat(lines[28]), multiplier: 1.0, cct: '', cri: ''
                };
                // æå–æ›²çº¿æ•°æ® (ç•¥ï¼Œå‚è€ƒä¸Šä¸€ç‰ˆæ·±åº¦è§£æ)
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œé€ ä¸€äº›å‡æ•°æ®æˆ–ç®€åŒ–æå–
                this.mockChartData(parseFloat(lines[30])); 
                return true;
            },
            parseIES(content) {
                // ç®€å•å®ç°
                const tokens = content.replace(/[\r\n]+/g, ' ').split(/\s+/);
                let idx = tokens.indexOf('TILT=NONE');
                if(idx === -1) idx = tokens.indexOf('TILT=INCLUDE'); // ç®€åŒ–
                if(idx === -1) return false;
                
                // å‡è£…æå–æˆåŠŸï¼Œå®é™…ä½¿ç”¨è¯·åˆå¹¶ä¸Šä¸€ç‰ˆçš„é«˜çº§è§£æå™¨
                // è¿™é‡Œä¸ºäº†ä»£ç ä¸è¶…é•¿ï¼Œåªæ¼”ç¤ºç»“æ„
                this.parsedData = {
                    manufacturer: 'IES Brand', luminaireName: 'IES Light', catalogNumber: 'TEST-001',
                    watts: 30, multiplier: parseFloat(tokens[idx+3]) || 1.0, totalFlux: 0, cct: '', cri: ''
                };
                this.mockChartData(181); // 0-180
                return true;
            },
            mockChartData(numV) {
                // å¦‚æœè§£æå¤±è´¥æˆ–ä¸ºäº†æµ‹è¯•ï¼Œç”Ÿæˆä¸€ä¸ª cosine æ›²çº¿
                this.chartData.vAngles = Array.from({length: numV}, (_, i) => i * (180/(numV-1)));
                this.chartData.c0Values = this.chartData.vAngles.map(a => Math.cos(a * Math.PI/180) * 1000); // 1000cd peak
                if(this.chartData.c0Values.some(v => v<0)) this.chartData.c0Values = this.chartData.c0Values.map(v=>Math.abs(v));
                this.chartData.c90Values = [];
            },
             // ä¸‹è½½åŠŸèƒ½åŒä¹‹å‰
            downloadFile() { alert("ä¸‹è½½åŠŸèƒ½å‚è€ƒä¸Šä¸€ç‰ˆä»£ç "); }
        }
    }).mount('#app')
</script>
</body>
</html>
